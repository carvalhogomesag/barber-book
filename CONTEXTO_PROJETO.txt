
*** SYSTEM INSTRUCTION PARA CONTINUIDADE DO PROJETO BARBER BOOK ***

CONTEXTO DO PROJETO:
Voc√™ est√° recebendo o c√≥digo fonte de um SaaS de gest√£o para barbearias (Barber Book).
O sistema √© um WebApp (React/Vite) integrado com Firebase (Auth, Firestore, Functions).

FUNCIONALIDADES J√Å IMPLEMENTADAS:
1. Multi-tenant: Barbeiros criam contas e t√™m dados isolados.
2. Agenda Visual: Drag & Drop, visualiza√ß√£o di√°ria.
3. IA no WhatsApp: Um rob√¥ (Gemini via Cloud Functions + Twilio) que atende clientes, l√™ a agenda e cria agendamentos reais.
4. Pagamentos: Integra√ß√£o com Stripe (Webhooks) para ativar plano PRO.
5. Internacionaliza√ß√£o: Suporte a Brasil (R$) e Portugal (‚Ç¨).

MUDAN√áA DE ESTRAT√âGIA (PIVOT) - SUA MISS√ÉO AGORA:
Decidimos simplificar a oferta de n√∫meros de telefone.
- ANTES: Tent√°vamos comprar n√∫meros locais (BR/PT) via Twilio.
- AGORA: Vamos oferecer APENAS n√∫meros dos Estados Unidos (+1) como um servi√ßo de "Concierge Internacional".
- MOTIVO: Evitar burocracia de documentos (Regulatory Bundles) e ativar o n√∫mero instantaneamente.

SUAS PR√ìXIMAS TAREFAS:
1. Analisar o arquivo 'functions/index.js' e alterar a fun√ß√£o 'provisionNumber' para buscar apenas n√∫meros 'US' (Estados Unidos), ignorando DDDs brasileiros.
2. Analisar 'src/pages/SetupPro.jsx' e remover a solicita√ß√£o de DDD brasileiro. O usu√°rio deve apenas escolher um "C√≥digo de √Årea Internacional" (ex: 305 Miami, 212 NY) ou gerar um aleat√≥rio dos EUA.

SEGUE ABAIXO O C√ìDIGO FONTE ATUAL DO PROJETO:


================================================================
IN√çCIO DOS ARQUIVOS DO PROJETO
================================================================



--- ARQUIVO: functions/index.js ---
```javascript
const { onRequest, onCall, HttpsError } = require("firebase-functions/v2/https");
const { onSchedule } = require("firebase-functions/v2/scheduler");
const { setGlobalOptions } = require("firebase-functions/v2");
const admin = require("firebase-admin");
const { GoogleGenerativeAI } = require("@google/generative-ai");
const twilio = require("twilio");

// 1. IMPORTA√á√ïES DE CONFIGURA√á√ÉO
const { REGION, CONCIERGE_NUMBER } = require("./config");

// 2. CONFIGURA√á√ÉO DE APIS
const stripe = require("stripe")(process.env.STRIPE_SECRET_KEY);
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const twilioClient = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);

// 3. IMPORTA√á√ÉO DOS CONTROLADORES E SERVI√áOS
const { handleIncomingMessage } = require("./src/controllers/webhookController");
const { processMessageWithAI } = require("./src/services/aiService"); // Importa√ß√£o necess√°ria para a voz usar a IA

admin.initializeApp();
setGlobalOptions({ region: REGION });

/**
 * [FUNCIONALIDADE: WHATSAPP WEBHOOK]
 * Gerencia mensagens de texto e detec√ß√µes de chamadas via webhookController.
 */
exports.whatsappWebhook = onRequest(async (req, res) => {
  return handleIncomingMessage(req, res);
});

/**
 * [FUNCIONALIDADE: L√ìGICA DE VOZ - SAUDA√á√ÉO INICIAL]
 * Gera o TwiML para a chamada de retorno quando o cliente atende.
 */
exports.voiceLogic = onRequest(async (req, res) => {
  const { barberId, to } = req.query;
  const db = admin.firestore();
  const voiceResponse = new twilio.twiml.VoiceResponse();

  try {
    const barberDoc = await db.collection('barbers').doc(barberId).get();
    const barberData = barberDoc.data();
    const lang = barberData.country === 'BR' ? 'pt-BR' : 'en-US';
    const barberName = barberData.barberShopName || "the professional";

    // Mensagem Inicial da IA
    const greeting = lang === 'pt-BR' 
      ? `Ol√°! Aqui √© a assistente inteligente da ${barberName}. Notei que voc√™ ligou agora pouco. Como posso te ajudar com seu agendamento?`
      : `Hello! This is the AI assistant for ${barberName}. I noticed you called a moment ago. How can I help you with your booking?`;

    voiceResponse.say({ voice: 'Polly.Vitoria', language: lang }, greeting);

    // Captura a resposta do cliente (Speech-to-Text)
    voiceResponse.gather({
      input: 'speech',
      action: `/voiceProcess?barberId=${barberId}`,
      language: lang,
      speechTimeout: 'auto'
    });

    res.type('text/xml').send(voiceResponse.toString());
  } catch (error) {
    console.error("Voice Logic Error:", error);
    res.status(500).send("Error");
  }
});

/**
 * [FUNCIONALIDADE: PROCESSAMENTO DE VOZ - C√âREBRO DA CHAMADA]
 * Recebe o que o cliente falou, processa via Gemini e responde por voz.
 */
exports.voiceProcess = onRequest(async (req, res) => {
  const { barberId } = req.query;
  const fromNumber = req.body.From; // N√∫mero do cliente
  const speechResult = req.body.SpeechResult; // Transcri√ß√£o autom√°tica do Twilio
  
  const db = admin.firestore();
  const voiceResponse = new twilio.twiml.VoiceResponse();

  try {
    const barberDoc = await db.collection('barbers').doc(barberId).get();
    const barberData = barberDoc.data();
    const lang = barberData.country === 'BR' ? 'pt-BR' : 'en-US';
    const voiceId = lang === 'pt-BR' ? 'Polly.Vitoria' : 'Polly.Joanna';

    // Se o Twilio n√£o conseguiu capturar nenhuma fala
    if (!speechResult) {
      const retryMsg = lang === 'pt-BR' ? "Desculpe, n√£o consegui ouvir. Poderia repetir?" : "I'm sorry, I couldn't hear you. Could you repeat?";
      voiceResponse.say({ voice: voiceId, language: lang }, retryMsg);
      voiceResponse.gather({
        input: 'speech',
        action: `/voiceProcess?barberId=${barberId}`,
        language: lang,
        speechTimeout: 'auto'
      });
      return res.type('text/xml').send(voiceResponse.toString());
    }

    // Identidade do Cliente (CRM)
    const mappingRef = db.collection("customer_mappings").doc(fromNumber);
    const mappingDoc = await mappingRef.get();
    const clientName = mappingDoc.exists ? mappingDoc.data().clientName : null;

    // Configura√ß√£o de IA
    const aiConfigSnap = await db.collection("settings").doc("ai_config").get();
    const globalAIConfig = aiConfigSnap.exists ? aiConfigSnap.data() : { additionalContext: "" };

    // PROCESSAMENTO PELA MESMA IA DO WHATSAPP
    const aiResponse = await processMessageWithAI({
      barberId,
      barberData,
      clientName,
      messageBody: `[PHONE CALL]: ${speechResult}`, // Marcador de contexto de voz
      fromNumber,
      db,
      mappingRef,
      globalAIConfig,
      targetLanguage: lang === 'pt-BR' ? 'Portuguese (Brazil)' : 'English (US)',
      barberTimezone: barberData.timezone || 'UTC',
      serverTimeISO: new Date().toISOString()
    });

    // Resposta em Voz para o Cliente
    voiceResponse.say({ voice: voiceId, language: lang }, aiResponse);

    // Permite que o cliente continue falando (Loop de conversa√ß√£o)
    voiceResponse.gather({
      input: 'speech',
      action: `/voiceProcess?barberId=${barberId}`,
      language: lang,
      speechTimeout: 'auto'
    });

    res.type('text/xml').send(voiceResponse.toString());

  } catch (error) {
    console.error("Voice Process Critical Error:", error);
    const errorMsg = "I'm sorry, I'm having a technical problem. I will send you a message on WhatsApp to finish your booking.";
    voiceResponse.say(errorMsg);
    res.type('text/xml').send(voiceResponse.toString());
  }
});

/**
 * [FUNCIONALIDADE: WEBHOOK STRIPE]
 * Gerencia a ativa√ß√£o do plano PRO e o pagamento de comiss√µes.
 */
exports.stripeWebhook = onRequest(async (req, res) => {
  const event = req.body;
  const db = admin.firestore();
  
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    const barberId = session.client_reference_id;
    if (!barberId) return res.status(400).send('No ID');
    
    try {
      const now = new Date();
      const trialEndsAt = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

      await db.collection('barbers').doc(barberId).update({ 
        plan: 'pro',
        proActivatedAt: now.toISOString(),
        trialExpiresAt: trialEndsAt.toISOString(),
        subscriptionStatus: 'trialing',
        stripeCustomerId: session.customer,
        customerEmail: session.customer_details?.email || null 
      });

      const barberDoc = await db.collection('barbers').doc(barberId).get();
      const barberData = barberDoc.data();

      if (barberData.referredBy) {
        const salesSnapshot = await db.collection('salespeople').where('referralCode', '==', barberData.referredBy).limit(1).get();
        if (!salesSnapshot.empty) {
          await salesSnapshot.docs[0].ref.update({ activeClients: admin.firestore.FieldValue.increment(1) });
        }
      }
      return res.status(200).send('Success');
    } catch (error) { return res.status(500).send('Error'); }
  } 
  
  if (event.type === 'invoice.paid') {
    const invoice = event.data.object;
    const customerId = invoice.customer;
    const amountPaid = invoice.amount_paid / 100;

    try {
      const barberSnapshot = await db.collection('barbers').where('stripeCustomerId', '==', customerId).limit(1).get();
      if (!barberSnapshot.empty) {
        const barberData = barberSnapshot.docs[0].data();
        if (barberData.referredBy) {
          const salesSnapshot = await db.collection('salespeople').where('referralCode', '==', barberData.referredBy).limit(1).get();
          if (!salesSnapshot.empty) {
            const commission = amountPaid * 0.20;
            await salesSnapshot.docs[0].ref.update({ 
                totalEarnings: admin.firestore.FieldValue.increment(commission),
                currentBalance: admin.firestore.FieldValue.increment(commission) 
            });
            await db.collection('commissions_log').add({
              salespersonId: salesSnapshot.docs[0].id,
              barberName: barberData.name,
              amountPaid: amountPaid,
              commissionEarned: commission,
              date: new Date().toISOString()
            });
          }
        }
      }
      return res.status(200).send('Commission Processed');
    } catch (error) { return res.status(500).send('Error'); }
  }
  return res.status(200).send('Ignored');
});

/**
 * [FUNCIONALIDADE: CRON JOB TRIAL]
 * Verifica√ß√£o di√°ria de trial e envio de alertas por e-mail.
 */
exports.checkTrialExpiration = onSchedule({
  schedule: "0 9 * * *",
  timeZone: "America/Sao_Paulo",
  memory: "256MiB"
}, async (event) => {
  const db = admin.firestore();
  const targetDate = new Date();
  targetDate.setDate(targetDate.getDate() + 2);
  const targetDateStr = targetDate.toISOString().split('T')[0];
  const snapshot = await db.collection('barbers')
    .where('trialExpiresAt', '>=', `${targetDateStr}T00:00:00`)
    .where('trialExpiresAt', '<=', `${targetDateStr}T23:59:59`)
    .where('subscriptionStatus', '==', 'trialing').get();

  if (snapshot.empty) return null;
  const emailPromises = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.customerEmail) {
      emailPromises.push(db.collection('mail').add({
        to: data.customerEmail,
        message: {
          subject: "Action Required: Your Schedy AI trial ends in 48 hours!",
          html: `<h2>Hello, ${data.name}!</h2><p>Your trial ends in 2 days.</p>`
        }
      }));
    }
  });
  return Promise.all(emailPromises);
});

/**
 * [FUNCIONALIDADE: PROVISIONAMENTO US (+1)]
 * Ativa√ß√£o instant√¢nea do n√∫mero internacional do Concierge.
 */
exports.provisionNumber = onCall(async (request) => {
  if (!request.auth) throw new HttpsError('unauthenticated', 'Login required');
  const areaCode = request.data?.areaCode || 'random';
  
  try {
    const updatePayload = {
      phone: CONCIERGE_NUMBER.replace('+', ''),
      numberCountry: 'US',
      numberType: 'international_concierge',
      selectedAreaCode: areaCode,
      numberActivatedAt: new Date().toISOString(),
      status: 'active'
    };

    await admin.firestore().collection('barbers').doc(request.auth.uid).update(updatePayload);
    
    return { success: true, phoneNumber: CONCIERGE_NUMBER, country: 'US' };
  } catch (error) { 
    console.error("Erro no provisionamento US:", error);
    throw new HttpsError('internal', error.message); 
  }
});

/**
 * [FUNCIONALIDADE: BILLING PORTAL]
 * Gera link para o portal de faturamento Stripe.
 */
exports.createPortalSession = onCall(async (request) => {
  if (!request.auth) throw new HttpsError('unauthenticated', 'Login required');
  try {
    const userDoc = await admin.firestore().collection('barbers').doc(request.auth.uid).get();
    const userData = userDoc.data();
    if (!userData || !userData.stripeCustomerId) throw new HttpsError('not-found', 'No Stripe ID');
    const session = await stripe.billingPortal.sessions.create({
      customer: userData.stripeCustomerId,
      return_url: 'https://barber-book-d4a5a.web.app/billing', 
    });
    return { url: session.url };
  } catch (error) { throw new HttpsError('internal', error.message); }
});

/**
 * [FUNCIONALIDADE: IA DE SUPORTE]
 * Agente Gemini para ajuda no Dashboard do profissional.
 */
exports.supportChat = onCall(async (request) => {
  const { message, history } = request.data;
  if (!message) throw new HttpsError('invalid-argument', 'Message is required');

  const selectedModel = process.env.GEMINI_MODEL;
  if (!selectedModel) throw new HttpsError('failed-precondition', 'AI Model missing.');

  try {
    const model = genAI.getGenerativeModel({ 
      model: selectedModel,
      systemInstruction: `Voc√™ √© o Schedy AI Support Agent. Voc√™ ajuda profissionais a configurar sua IA. Hoje √© ${new Date().toISOString().split('T')[0]}.`
    });

    let cleanHistory = [];
    if (Array.isArray(history)) {
      cleanHistory = history.map(h => ({
        role: h.role === 'model' ? 'model' : 'user',
        parts: [{ text: h.parts[0].text }]
      }));
    }

    const chat = model.startChat({ history: cleanHistory });
    const result = await chat.sendMessage(message);
    const response = await result.response;
    
    return { text: response.text() };
  } catch (error) {
    console.error("Erro no Support Chat:", error);
    throw new HttpsError('internal', 'AI Assistant error');
  }
});
```


--- ARQUIVO: functions/package.json ---
```javascript
{
  "name": "functions",
  "description": "Cloud Functions for Firebase",
  "scripts": {
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "22"
  },
  "main": "index.js",
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "dotenv": "^17.2.4",
    "firebase-admin": "^13.6.0",
    "firebase-functions": "^7.0.5",
    "stripe": "^20.3.1",
    "twilio": "^5.12.0"
  },
  "devDependencies": {
    "firebase-functions-test": "^3.4.1"
  },
  "private": true
}

```


--- ARQUIVO: src/services/firebase.js ---
```javascript
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getFunctions } from "firebase/functions";

const firebaseConfig = {
  apiKey: "AIzaSyAXgcYUT1D-bK-AFjMgA_Q6ceBFmc0AtDQ",
  authDomain: "barber-book-d4a5a.firebaseapp.com",
  projectId: "barber-book-d4a5a",
  storageBucket: "barber-book-d4a5a.firebasestorage.app",
  messagingSenderId: "18598107835",
  appId: "1:18598107835:web:30d12d855328a880afa79e"
};

// 1. Inicializa o App
const app = initializeApp(firebaseConfig);

// 2. Exporta o app e os servi√ßos
export const auth = getAuth(app);
export const db = getFirestore(app);
export const functions = getFunctions(app, 'us-central1');
export { app }; // <--- ESSA LINHA √â CRUCIAL
```


--- ARQUIVO: src/services/barberService.js (N√ÉO ENCONTRADO) ---


--- ARQUIVO: src/services/adminService.js ---
```javascript
import { db } from './firebase';
import { 
  collection, 
  getDocs, 
  doc, 
  setDoc,
  updateDoc, 
  deleteDoc, 
  query, 
  where, 
  orderBy,
  addDoc
} from 'firebase/firestore';

const BARBERS_COLLECTION = 'barbers'; 
const SUBSCRIPTIONS_COLLECTION = 'subscriptions'; 
const SALESPEOPLE_COLLECTION = 'salespeople'; 
const PAYOUTS_COLLECTION = 'payouts'; 

// ==========================================
// GEST√ÉO DE PROFISSIONAIS (TENANTS)
// ==========================================

/**
 * Buscar todos os profissionais cadastrados no sistema
 */
export const getAllTenants = async () => {
  const q = query(collection(db, BARBERS_COLLECTION), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
};

/**
 * Atualizar dados de um profissional
 */
export const adminUpdateTenant = async (tenantId, data) => {
  const docRef = doc(db, BARBERS_COLLECTION, tenantId);
  await updateDoc(docRef, data);
};

/**
 * Alternar Status do Profissional (Ativo/Inativo) - NOVO
 * Esta fun√ß√£o bloqueia o acesso sem apagar os dados.
 */
export const adminToggleTenantStatus = async (tenantId, currentStatus) => {
  const docRef = doc(db, BARBERS_COLLECTION, tenantId);
  const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
  await updateDoc(docRef, { 
    status: newStatus,
    statusUpdatedAt: new Date().toISOString()
  });
};

/**
 * Deletar um profissional do sistema (Exclus√£o F√≠sica)
 */
export const adminDeleteTenant = async (tenantId) => {
  await deleteDoc(doc(db, BARBERS_COLLECTION, tenantId));
};

// ==========================================
// GEST√ÉO COMERCIAL (VENDEDORES / AFILIADOS)
// ==========================================

/**
 * Cria um novo colaborador comercial.
 */
export const createSalesperson = async (data) => {
  const newSalesRef = doc(collection(db, SALESPEOPLE_COLLECTION));
  
  const salespersonData = {
    ...data,
    role: 'sales',
    commissionRate: 0.20,
    totalEarnings: 0,   
    currentBalance: 0,  
    activeClients: 0,
    createdAt: new Date().toISOString(),
    status: 'active' // Status inicial padr√£o
  };

  await setDoc(newSalesRef, salespersonData);
  return { id: newSalesRef.id, ...salespersonData };
};

/**
 * Busca todos os vendedores para o painel do Admin.
 */
export const getAllSalespeople = async () => {
  const q = query(collection(db, SALESPEOPLE_COLLECTION), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
};

/**
 * Busca todos os clientes (barbeiros) vinculados a um vendedor espec√≠fico.
 */
export const getClientsBySalesperson = async (salespersonCode) => {
  const q = query(
    collection(db, BARBERS_COLLECTION), 
    where("referredBy", "==", salespersonCode)
  );
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
};

/**
 * ATUALIZA DADOS DO VENDEDOR
 */
export const updateSalesperson = async (salesId, data) => {
  const docRef = doc(db, SALESPEOPLE_COLLECTION, salesId);
  await updateDoc(docRef, data);
};

/**
 * Alternar Status do Vendedor (Ativo/Inativo) - NOVO
 * Permite suspender um parceiro comercial imediatamente.
 */
export const adminToggleSalespersonStatus = async (salesId, currentStatus) => {
  const docRef = doc(db, SALESPEOPLE_COLLECTION, salesId);
  const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
  await updateDoc(docRef, { 
    status: newStatus,
    statusUpdatedAt: new Date().toISOString()
  });
};

/**
 * DELETAR VENDEDOR (Exclus√£o F√≠sica)
 */
export const adminDeleteSalesperson = async (salesId) => {
  const docRef = doc(db, SALESPEOPLE_COLLECTION, salesId);
  await deleteDoc(docRef);
};

// ==========================================
// AUTO-GEST√ÉO DE CONTA (USU√ÅRIO FINAL) - NOVO
// ==========================================

/**
 * Solicitar Encerramento de Conta
 * Usado pelo pr√≥prio Barbeiro ou Vendedor na p√°gina de Perfil.
 */
export const requestAccountClosure = async (userId, role) => {
  const collectionName = role === 'sales' ? SALESPEOPLE_COLLECTION : BARBERS_COLLECTION;
  const docRef = doc(db, collectionName, userId);
  
  await updateDoc(docRef, {
    status: 'closure_requested',
    closureRequestedAt: new Date().toISOString()
  });
};

// ==========================================
// GEST√ÉO DE SAQUES (PAYOUTS)
// ==========================================

export const getAllPayoutRequests = async () => {
  const q = query(collection(db, PAYOUTS_COLLECTION), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
};

export const adminApprovePayout = async (payoutId, salespersonId, amount) => {
  const payoutRef = doc(db, PAYOUTS_COLLECTION, payoutId);
  await updateDoc(payoutRef, {
    status: 'paid',
    paidAt: new Date().toISOString()
  });
};

// ==========================================
// BUSINESS INTELLIGENCE (ASSINATURAS)
// ==========================================

export const getAllSubscriptions = async () => {
  const q = query(collection(db, SUBSCRIPTIONS_COLLECTION), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
};
```


--- ARQUIVO: src/contexts/AuthContext.jsx ---
```javascript
import React, { createContext, useState, useEffect, useContext } from 'react';
import { onAuthStateChanged, signOut } from 'firebase/auth';
import { doc, onSnapshot, getDoc } from 'firebase/firestore'; // Adicionei getDoc
import { auth, db } from '../services/firebase';

const AuthContext = createContext({});

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null); 
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let unsubscribeSnapshot = null;

    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);

      // Limpa qualquer ouvinte anterior ao trocar de usu√°rio
      if (unsubscribeSnapshot) {
        unsubscribeSnapshot();
        unsubscribeSnapshot = null;
      }

      if (currentUser) {
        try {
            // 1. Verifica se √© um Barbeiro
            const barberRef = doc(db, 'barbers', currentUser.uid);
            const barberDoc = await getDoc(barberRef);

            if (barberDoc.exists()) {
                // Conecta o monitoramento em tempo real
                unsubscribeSnapshot = onSnapshot(barberRef, (docSnap) => {
                    const data = docSnap.data();
                    if (data?.status === 'inactive') {
                        signOut(auth);
                        alert("Your account is inactive.");
                    } else {
                        setProfile({ id: docSnap.id, ...data });
                    }
                    setLoading(false);
                });
                return; // Encerra aqui, pois j√° achou
            }

            // 2. Verifica se √© um Vendedor
            const salesRef = doc(db, 'salespeople', currentUser.uid);
            const salesDoc = await getDoc(salesRef);

            if (salesDoc.exists()) {
                // Conecta o monitoramento em tempo real
                unsubscribeSnapshot = onSnapshot(salesRef, (docSnap) => {
                    const data = docSnap.data();
                    if (data?.status === 'inactive') {
                        signOut(auth);
                        alert("Partner account suspended.");
                    } else {
                        setProfile({ id: docSnap.id, ...data });
                    }
                    setLoading(false);
                });
                return; // Encerra aqui
            }

            // 3. Se chegou aqui, n√£o existe perfil (Conta Fantasma)
            console.warn("Security: No profile found for user. Signing out.");
            await signOut(auth);
            setProfile(null);
            setLoading(false);

        } catch (error) {
            console.error("Auth Error:", error);
            setLoading(false);
        }
      } else {
        setProfile(null);
        setLoading(false);
      }
    });

    return () => {
      unsubscribeAuth();
      if (unsubscribeSnapshot) unsubscribeSnapshot();
    };
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen bg-barber-dark flex flex-col items-center justify-center gap-4">
        <div className="w-12 h-12 border-4 border-barber-gold border-t-transparent rounded-full animate-spin"></div>
        <p className="text-barber-gray text-[10px] font-black uppercase tracking-[0.2em] animate-pulse">
          Securing Session...
        </p>
      </div>
    );
  }

  return (
    <AuthContext.Provider value={{ user, profile }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);
```


--- ARQUIVO: src/utils/timeGrid.js ---
```javascript
import { setHours, startOfDay, addMinutes, roundToNearestMinutes } from 'date-fns';

/**
 * CONFIGURA√á√ïES DE VISIBILIDADE (UX FOCUS)
 * Definimos o foco comercial: das 07:00 √†s 22:00.
 */
export const START_HOUR = 7; 
export const END_HOUR = 22;  

/**
 * PIXELS_PER_HOUR
 * Ajustado para 100px para dar uma sensa√ß√£o de amplitude e luxo no "Light Mode".
 */
export const PIXELS_PER_HOUR = 100; 

/**
 * Calcula a posi√ß√£o (TOP) de um hor√°rio espec√≠fico no grid.
 * O c√°lculo √© relativo √† START_HOUR (07:00).
 */
export const getPositionFromTime = (dateString, customPixelsPerHour = PIXELS_PER_HOUR) => {
  const date = new Date(dateString);
  
  // Criamos a √¢ncora de in√≠cio do grid (Ex: Hoje √†s 07:00)
  const anchorDate = setHours(startOfDay(date), START_HOUR);
  
  // Diferen√ßa em horas decimais
  const diffInHours = (date.getTime() - anchorDate.getTime()) / (1000 * 60 * 60);
  
  // Se o hor√°rio for antes das 07:00, retornamos 0 para n√£o quebrar o layout
  return Math.max(0, diffInHours * customPixelsPerHour);
};

/**
 * Calcula a altura do card baseada na dura√ß√£o do servi√ßo.
 * Um servi√ßo de 60min ter√° exatamente customPixelsPerHour de altura.
 */
export const getHeightFromDuration = (durationInMinutes, customPixelsPerHour = PIXELS_PER_HOUR) => {
  return (durationInMinutes / 60) * customPixelsPerHour;
};

/**
 * Gera a lista de horas (07:00 a 22:00) para o eixo lateral.
 */
export const hoursArray = Array.from(
  { length: END_HOUR - START_HOUR + 1 },
  (_, i) => START_HOUR + i
);

/**
 * L√ìGICA DE DRAG & DROP (SNAP)
 * Converte o movimento de pixels de volta para um hor√°rio ISO.
 */
export const getNewStartTime = (originalStartTime, pixelsMoved, customPixelsPerHour = PIXELS_PER_HOUR) => {
  const originalDate = new Date(originalStartTime);
  
  // Converte pixels em minutos totais movidos
  const minutesMoved = (pixelsMoved / customPixelsPerHour) * 60;
  
  // Calcula nova data bruta
  let newDate = addMinutes(originalDate, minutesMoved);
  
  // UX SNAP: Im√£ de 15 minutos para facilitar o encaixe perfeito na agenda
  newDate = roundToNearestMinutes(newDate, { nearestTo: 15 });
  
  // Bloqueio de limite superior (N√£o deixar arrastar para antes das 07:00)
  const minLimit = setHours(startOfDay(newDate), START_HOUR);
  if (newDate < minLimit) return minLimit.toISOString();

  return newDate.toISOString();
};

/**
 * Formata a exibi√ß√£o de hora no padr√£o 24h elegante (High Contrast)
 */
export const formatTimeDisplay = (isoString) => {
  if (!isoString) return "--:--";
  const date = new Date(isoString);
  return date.toLocaleTimeString('pt-BR', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
  });
};

/**
 * TOTAL_GRID_HEIGHT
 * √ötil para definir a altura total do container de scroll do calend√°rio.
 */
export const TOTAL_GRID_HEIGHT = (END_HOUR - START_HOUR + 1) * PIXELS_PER_HOUR;
```


--- ARQUIVO: src/App.jsx ---
```javascript
import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Landing } from './pages/Landing'; 
import { Login } from './pages/Login';
import { Register } from './pages/Register';
import { Dashboard } from './pages/Dashboard';
import { Services } from './pages/Services';
import { Profile } from './pages/Profile';
import { Pricing } from './pages/Pricing';
import { Terms } from './pages/Terms';
import { Admin } from './pages/Admin';
import { SetupPro } from './pages/SetupPro';
import { AdminDashboard } from './pages/AdminDashboard'; 
import { Billing } from './pages/Billing'; 
import { SalesDashboard } from './pages/SalesDashboard'; 
import { JoinSales } from './pages/JoinSales'; 
import { Support } from './pages/Support'; 
import { SalesCRM } from './pages/SalesCRM'; 
import { SalesAnalytics } from './pages/SalesAnalytics'; 

// IMPORTA√á√ÉO DA NOVA P√ÅGINA DE NOTIFICA√á√ïES
import { Notifications } from './pages/Notifications';

// COMPONENTES GLOBAIS
import { CookieConsent } from './components/ui/CookieConsent';
import { PWAInstallPrompt } from './components/ui/PWAInstallPrompt';

// NOVAS P√ÅGINAS
import { Customers } from './pages/Customers';
import { Messages } from './pages/Messages';

function App() {
  return (
    <BrowserRouter>
      {/* AVISO DE COOKIES (Global) */}
      <CookieConsent />

      {/* PROMPT DE INSTALA√á√ÉO PWA (Global) */}
      <PWAInstallPrompt />

      <Routes>
        {/* ROTAS P√öBLICAS (Convers√£o e Ajuda) */}
        <Route path="/" element={<Landing />} />
        <Route path="/join-sales" element={<JoinSales />} />
        <Route path="/support" element={<Support />} />
        
        {/* ROTAS DE ACESSO */}
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        
        {/* DASHBOARD PRINCIPAL (BARBEIRO) */}
        <Route path="/dashboard" element={<Dashboard />} />
        
        {/* ROTAS DE GEST√ÉO E CRM */}
        <Route path="/customers" element={<Customers />} />
        <Route path="/messages" element={<Messages />} />
        <Route path="/notifications" element={<Notifications />} /> {/* Nova Rota: Caixa de Entrada da IA */}
        <Route path="/services" element={<Services />} />
        
        {/* CONFIGURA√á√ïES E PERFIL */}
        <Route path="/profile" element={<Profile />} />
        <Route path="/pricing" element={<Pricing />} />
        <Route path="/setup-pro" element={<SetupPro />} />
        <Route path="/billing" element={<Billing />} /> 
        
        {/* DEPARTAMENTO COMERCIAL (VENDEDOR) */}
        <Route path="/sales-console" element={<SalesDashboard />} /> 
        <Route path="/sales-crm" element={<SalesCRM />} /> 
        <Route path="/sales-analytics" element={<SalesAnalytics />} /> 
        
        {/* INSTITUCIONAL E ADMIN */}
        <Route path="/terms" element={<Terms />} />
        <Route path="/admin" element={<Admin />} /> 
        <Route path="/admin-dashboard" element={<AdminDashboard />} /> 
      </Routes>
    </BrowserRouter>
  );
}

export default App;
```


--- ARQUIVO: src/main.jsx ---
```javascript
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import './index.css';
import { AuthProvider } from './contexts/AuthContext';

// Importa√ß√£o necess√°ria para o PWA (Vite Plugin PWA)
import { registerSW } from 'virtual:pwa-register';

// Registra o Service Worker para habilitar instala√ß√£o e cache
// immediate: true faz com que o app se atualize assim que houver uma nova vers√£o
registerSW({ immediate: true });

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    {/* Envolvemos o App inteiro com o AuthProvider */}
    <AuthProvider>
      <App />
    </AuthProvider>
  </React.StrictMode>,
);
```


--- ARQUIVO: src/index.css ---
```javascript
@tailwind base;
@tailwind components;
@tailwind utilities;

/* 1. RESET DE FUNDO E CONTRASTE (LIGHT MODE) */
body {
  background-color: #F4F7F9; /* Schedy Canvas */
  color: #0A0A0B; /* Schedy Black */
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  overflow: hidden; /* O scroll ser√° controlado internamente pelos componentes */
  -webkit-font-smoothing: antialiased;
}

/* 2. SCROLLBARS MINIMALISTAS (PREMIUM UI) */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #E2E8F0; /* Schedy Border */
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #64748B; /* Schedy Gray */
}

/* 3. CAMADAS DE PROFUNDIDADE (Z-INDEX) */
.z-sidebar { z-index: 50; }
.z-modal { z-index: 100; }
.z-tooltip { z-index: 60; }

/* 4. ANIMA√á√ÉO DE PULSO PARA CARDS COM NOTAS (REESTILIZADO) */
@keyframes pulse-service {
  0%, 100% {
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    transform: scale(1.01);
  }
}

.animate-pulse-service {
  animation: pulse-service 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* 5. FIX PARA ELEMENTOS QUE FICAM ATR√ÅS DA SIDEBAR */
main {
  position: relative;
  z-index: 10;
}

/* 6. CORRE√á√ÉO DE BOT√ïES "BRANCO NO BRANCO" */
button[variant="outline"] {
  border: 2px solid #0A0A0B;
  background-color: transparent;
  color: #0A0A0B;
}

button[variant="outline"]:hover {
  background-color: #0A0A0B;
  color: #FFFFFF;
}

/* 7. ESTILIZA√á√ÉO DO MODAL PARA LARGURA TOTAL */
.modal-wide {
  max-width: 900px !important;
  width: 95% !important;
}
```


--- ARQUIVO: tailwind.config.js ---
```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        schedy: {
          // Fundo principal ultra-limpo para contraste m√°ximo
          canvas: '#F4F7F9', 
          white: '#FFFFFF',
          // Tipografia pesada e leg√≠vel (High-Contrast)
          black: '#0A0A0B',
          gray: '#64748B',
          // Cor de destaque (Primary Action)
          accent: '#000000', 
          danger: '#EF4444',
          border: '#E2E8F0',
        },
        // Paleta Vivid para Categorias de Servi√ßo (WOW Factor)
        service: {
          emerald: '#10B981', // Ex: Corte Tradicional
          amber: '#F59E0B',   // Ex: Barba
          indigo: '#6366F1',  // Ex: Combo/Qu√≠mica
          rose: '#F43F5E',    // Ex: Tratamento/Pele
          violet: '#8B5CF6',  // Ex: Colora√ß√£o
          sky: '#0EA5E9',     // Ex: Infantil
          orange: '#F97316',  // Ex: Especial/Noivo
        }
      },
      // Configura√ß√£o para a Sidebar Retr√°til
      spacing: {
        'sidebar-wide': '240px',
        'sidebar-slim': '72px',
      },
      // Sombras premium para profundidade nos cards
      boxShadow: {
        'premium': '0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 10px -2px rgba(0, 0, 0, 0.03)',
        'vivid': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
      }
    },
  },
  plugins: [],
}
```


--- ARQUIVO: src/pages/Login.jsx ---
```javascript
import React, { useState } from 'react';
import { signInWithEmailAndPassword, sendPasswordResetEmail } from 'firebase/auth';
import { auth } from '../services/firebase';
import { Button } from '../components/ui/Button';
import { Input } from '../components/ui/Input';
import { Scissors } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { getProfessionalProfile } from '../services/professionalService';
import { getSalespersonProfile } from '../services/salesService';

export function Login() {
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [resetLoading, setResetLoading] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setMessage('');

    try {
      // 1. Realiza o login no Firebase Auth
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 2. REDIRECIONAMENTO INTELIGENTE
      
      // A. Verifica na cole√ß√£o de Profissionais/Admins
      const professionalProfile = await getProfessionalProfile();
      
      if (professionalProfile) {
        // SE FOR ADMIN, VAI PARA O PAINEL DE GEST√ÉO
        if (professionalProfile.role === 'admin') {
          navigate('/admin');
        } else {
          // SE FOR BARBEIRO, VAI PARA A AGENDA
          navigate('/dashboard');
        }
        return;
      }

      // B. Verifica na cole√ß√£o de Vendedores
      const salesProfile = await getSalespersonProfile(user.uid);
      if (salesProfile) {
        navigate('/sales-console');
        return;
      }

      // Fallback de seguran√ßa
      navigate('/dashboard'); 

    } catch (err) {
      console.error(err);
      setError("Login failed. Please check your email and password.");
    } finally {
      setLoading(false);
    }
  };

  // Fun√ß√£o para recuperar senha (Preservada)
  const handleForgotPassword = async () => {
    if (!email) {
      setError("Please enter your email address first.");
      return;
    }
    
    setResetLoading(true);
    setError('');
    try {
      await sendPasswordResetEmail(auth, email);
      setMessage("Password reset email sent! Check your inbox.");
    } catch (err) {
      setError("Error sending reset email. Verify if the email is correct.");
    } finally {
      setResetLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-barber-dark flex items-center justify-center p-4">
      <div className="w-full max-w-md bg-barber-black p-8 rounded-2xl border border-zinc-800 shadow-2xl">
        
        <div className="flex flex-col items-center gap-2 mb-8">
          <div className="w-16 h-16 bg-barber-gold rounded-full flex items-center justify-center text-barber-black shadow-lg shadow-barber-gold/20">
            <Scissors size={32} />
          </div>
          <h1 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter">Schedy Login</h1>
          <p className="text-barber-gray text-sm font-medium">Access your AI-powered dashboard</p>
        </div>

        <form onSubmit={handleLogin} className="flex flex-col gap-4">
          <Input 
            label="E-mail" 
            type="email"
            placeholder="your@email.com" 
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
          
          <div className="space-y-1">
            <Input 
              label="Password" 
              type="password" 
              placeholder="******" 
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
            <div className="flex justify-end">
                <button 
                    type="button" 
                    onClick={handleForgotPassword}
                    disabled={resetLoading}
                    className="text-[10px] font-black text-barber-gold uppercase tracking-widest hover:text-white transition-colors flex items-center gap-1"
                >
                    {resetLoading ? "Sending..." : "Forgot Password?"}
                </button>
            </div>
          </div>

          {error && (
            <div className="text-red-500 text-xs text-center bg-red-500/10 p-3 rounded border border-red-500/20 font-bold">
                {error}
            </div>
          )}

          {message && (
            <div className="text-green-500 text-xs text-center bg-green-500/10 p-3 rounded border border-green-500/20 font-bold">
                {message}
            </div>
          )}

          <Button type="submit" loading={loading} className="h-14 font-black uppercase italic tracking-tighter">
            Sign In
          </Button>
        </form>

        <div className="mt-8 text-center space-y-4 border-t border-zinc-800 pt-6">
          <p className="text-xs text-barber-gray font-bold uppercase tracking-widest">
            New to Schedy AI?
          </p>
          <div className="grid grid-cols-2 gap-3">
            <Button variant="outline" onClick={() => navigate('/register')} className="h-10 text-[10px] font-black uppercase">
                Professional
            </Button>
            <Button variant="outline" onClick={() => navigate('/join-sales')} className="h-10 text-[10px] font-black uppercase border-zinc-700 text-zinc-500">
                Partner
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
```


--- ARQUIVO: src/pages/Register.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { createUserWithEmailAndPassword } from 'firebase/auth';
import { doc, setDoc, getDocs, collection, query, where, deleteDoc } from 'firebase/firestore';
import { auth, db } from '../services/firebase';
import { Button } from '../components/ui/Button';
import { Input } from '../components/ui/Input';
import { Link, useNavigate, useSearchParams } from 'react-router-dom';
import { UserPlus, Globe, Tag, Briefcase, X, ShieldCheck } from 'lucide-react';

const SUPPORTED_COUNTRIES = {
  US: { name: 'United States', ddi: '1', currency: '$', timezone: 'America/New_York', flag: 'üá∫üá∏' },
  BR: { name: 'Brasil', ddi: '55', currency: 'R$', timezone: 'America/Sao_Paulo', flag: 'üáßüá∑' },
  PT: { name: 'Portugal', ddi: '351', currency: '‚Ç¨', timezone: 'Europe/Lisbon', flag: 'üáµüáπ' },
  ES: { name: 'Espa√±a', ddi: '34', currency: '‚Ç¨', timezone: 'Europe/Madrid', flag: 'üá™üá∏' },
  FR: { name: 'France', ddi: '33', currency: '‚Ç¨', timezone: 'Europe/Paris', flag: 'üá´üá∑' },
  IT: { name: 'Italia', ddi: '39', currency: '‚Ç¨', timezone: 'Europe/Rome', flag: 'üáÆüáπ' },
  GB: { name: 'United Kingdom', ddi: '44', currency: '¬£', timezone: 'Europe/London', flag: 'üá¨üáß' },
};

export function Register() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [country, setCountry] = useState('US');
  const [referralCode, setReferralCode] = useState(''); 
  const [acceptedTerms, setAcceptedTerms] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const isSalesMode = searchParams.get('role') === 'sales';

  useEffect(() => {
    const ref = searchParams.get('ref');
    if (ref) {
      setReferralCode(ref.toUpperCase());
    }
  }, [searchParams]);

  const generateReferralCode = (userName) => {
    const prefix = userName.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'SAL');
    const random = Math.floor(100 + Math.random() * 900);
    return `${prefix}${random}`;
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    
    if (!acceptedTerms) {
      setError("You must accept the Terms of Service to continue.");
      return;
    }

    setLoading(true);
    setError('');

    const cleanEmail = email.toLowerCase().trim();
    const nowISO = new Date().toISOString();

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, cleanEmail, password);
      const user = userCredential.user;
      const selectedCountryData = SUPPORTED_COUNTRIES[country];

      if (isSalesMode) {
        // L√ìGICA DE VENDEDOR
        const salesQuery = query(collection(db, "salespeople"), where("email", "==", cleanEmail));
        const querySnapshot = await getDocs(salesQuery);
        
        let finalSalesData = {
          name: name,
          email: cleanEmail,
          country: country,
          ddi: selectedCountryData.ddi,
          referralCode: generateReferralCode(name),
          role: "sales",
          commissionRate: 0.20,
          totalEarnings: 0,
          currentBalance: 0,
          activeClients: 0,
          status: 'active',
          createdAt: nowISO,
        };

        if (!querySnapshot.empty) {
          const existingDoc = querySnapshot.docs[0];
          await deleteDoc(doc(db, "salespeople", existingDoc.id));
        }

        await setDoc(doc(db, "salespeople", user.uid), finalSalesData);
        navigate('/sales-console');

      } else {
        // L√ìGICA DE BARBEIRO (PROFISSIONAL)
        // Injetamos configura√ß√µes padr√£o para evitar que a IA "alucine" antes do primeiro Setup
        await setDoc(doc(db, "barbers", user.uid), {
          name: name,
          barberShopName: name, 
          email: cleanEmail,
          plan: "free",
          role: "professional",
          country: country,
          currency: selectedCountryData.currency,
          timezone: selectedCountryData.timezone,
          ddi: selectedCountryData.ddi,
          referredBy: referralCode.trim().toUpperCase() || null,
          status: 'active',
          createdAt: nowISO,
          acceptedTermsAt: nowISO,
          // DEFAULT SETTINGS: Crucial para a integridade da IA (utils.js)
          settings: {
            businessHours: {
              open: "09:00",
              close: "18:00",
              days: [1, 2, 3, 4, 5], // Seg a Sex por padr√£o
              break: "12:00-13:00"
            },
            aiPreference: 'professional'
          }
        });

        // Redireciona para o Perfil para o usu√°rio revisar Timezone e Moeda
        navigate('/profile'); 
      }

    } catch (err) {
      console.error("Registration Error:", err);
      if (err.code === 'auth/email-already-in-use') {
        setError("This email is already in use.");
      } else if (err.code === 'auth/weak-password') {
        setError("Password is too weak (min. 6 characters).");
      } else {
        setError("Registration failed. Please try again.");
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-barber-dark flex items-center justify-center p-4 animate-in fade-in duration-500">
      <div className="w-full max-w-md bg-barber-black p-8 rounded-3xl border border-zinc-800 shadow-2xl relative">
        
        <button 
          onClick={() => navigate('/login')}
          className="absolute top-6 right-6 text-zinc-500 hover:text-white transition-colors p-2 hover:bg-zinc-900 rounded-xl"
        >
          <X size={20} />
        </button>

        <div className="flex flex-col items-center gap-2 mb-8">
          <div className={`w-16 h-16 rounded-full flex items-center justify-center border ${
            isSalesMode ? 'bg-barber-gold/10 text-barber-gold border-barber-gold/20' : 'bg-barber-red/10 text-barber-red border-barber-red/20'
          }`}>
            {isSalesMode ? <Briefcase size={32} /> : <UserPlus size={32} />}
          </div>
          <h1 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter">
            {isSalesMode ? 'Partner Activation' : 'Get Started'}
          </h1>
          <p className="text-barber-gray text-xs text-center font-bold uppercase tracking-widest opacity-70">
            {isSalesMode ? 'Access your sales console' : 'Join the International AI Concierge'}
          </p>
        </div>

        <form onSubmit={handleRegister} className="flex flex-col gap-4">
          
          <div className="flex flex-col gap-1">
            <label className="text-[10px] text-barber-gray font-black uppercase tracking-widest flex items-center gap-2">
              <Globe size={12} className="text-barber-gold" /> Service Location
            </label>
            <select 
              value={country}
              onChange={(e) => setCountry(e.target.value)}
              className="bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-sm text-barber-white focus:border-barber-gold outline-none transition-all appearance-none cursor-pointer font-bold"
            >
              {Object.keys(SUPPORTED_COUNTRIES).map((key) => (
                <option key={key} value={key}>
                  {SUPPORTED_COUNTRIES[key].flag} {SUPPORTED_COUNTRIES[key].name}
                </option>
              ))}
            </select>
          </div>

          <Input 
            label={isSalesMode ? "Full Name" : "Business Name"} 
            placeholder={isSalesMode ? "Your name" : "Ex: Barber Authority"} 
            value={name}
            onChange={(e) => setName(e.target.value)}
            required
          />

          <Input 
            label="Professional E-mail" 
            type="email"
            placeholder="your@email.com" 
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
          
          <Input 
            label="Secure Password" 
            type="password" 
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />

          {!isSalesMode && (
            <div className="relative">
              <Input 
                label="Referral Code (Optional)" 
                placeholder="Ex: MIAMI20" 
                value={referralCode}
                onChange={(e) => setReferralCode(e.target.value)}
              />
              <Tag size={16} className="absolute right-3 top-10 text-zinc-700" />
            </div>
          )}

          <div className="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800/50 mb-2">
            <div className="flex items-start gap-3">
                <input 
                type="checkbox" 
                id="terms"
                checked={acceptedTerms}
                onChange={(e) => setAcceptedTerms(e.target.checked)}
                className="mt-1 w-4 h-4 rounded border-zinc-700 bg-zinc-800 text-barber-gold focus:ring-barber-gold transition-all cursor-pointer"
                />
                <label htmlFor="terms" className="text-[10px] text-barber-gray leading-tight cursor-pointer select-none font-medium">
                I accept the <Link to="/terms" className="text-barber-gold hover:underline font-bold">Terms of Service</Link> 
                {!isSalesMode && " and understand my AI Concierge will use a dedicated US (+1) number for global authority."}
                </label>
            </div>
          </div>

          {error && (
            <div className="text-red-500 text-[10px] text-center bg-red-500/10 p-3 rounded-xl border border-red-500/20 font-black uppercase tracking-widest">
              {error}
            </div>
          )}

          <Button type="submit" loading={loading} variant="primary" className="mt-2 h-14 uppercase font-black tracking-tighter italic text-lg">
            {isSalesMode ? 'Activate Account' : 'Create Free Account'}
          </Button>
        </form>

        <div className="mt-6 text-center border-t border-zinc-800 pt-6">
          <p className="text-xs text-barber-gray font-bold uppercase tracking-widest">
            Already a member? <Link to="/login" className="text-barber-gold hover:underline font-black">Log In</Link>
          </p>
        </div>
      </div>
    </div>
  );
}
```


--- ARQUIVO: src/pages/Dashboard.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { DayView } from '../components/calendar/DayView';
import { AppointmentModal } from '../components/dashboard/AppointmentModal';
import { BlockModal } from '../components/dashboard/BlockModal';
import { Button } from '../components/ui/Button';
import { Plus, Lock, Sun } from 'lucide-react';
import { format, isSameDay, startOfWeek, endOfWeek } from 'date-fns';
import { 
  getServices, 
  addAppointment, 
  getAppointments, 
  updateAppointmentTime,
  updateAppointmentFull,
  deleteAppointment,
  getProfessionalProfile,
  addBlockedTime 
} from '../services/professionalService'; 

export function Dashboard() {
  // --- ESTADOS DE DADOS ---
  const [profile, setProfile] = useState(null);
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [appointments, setAppointments] = useState([]);
  const [services, setServices] = useState([]);
  const [businessHours, setBusinessHours] = useState({ open: "07:00", close: "22:00", break: "12:00-13:00" });

  // --- ESTADOS DE UI ---
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isBlockModalOpen, setIsBlockModalOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [editingAppointment, setEditingAppointment] = useState(null);
  const [modalInitialDate, setModalInitialDate] = useState(new Date());

  const timezone = profile?.timezone || 'Europe/Lisbon';

  // --- CARREGAMENTO INICIAL ---
  useEffect(() => {
    loadInitialData();
    const interval = setInterval(refreshAppointments, 15000); 
    return () => clearInterval(interval);
  }, []); 

  const loadInitialData = async () => {
    try {
      const prof = await getProfessionalProfile();
      if (prof) {
        setProfile(prof);
        if (prof.settings?.businessHours) {
          setBusinessHours(prev => ({ ...prev, ...prof.settings.businessHours }));
        }
      }
      const servicesData = await getServices();
      setServices(servicesData);
      await refreshAppointments();
    } catch (error) { console.error("Sync Error:", error); }
  };

  const refreshAppointments = async () => {
    try {
      const data = await getAppointments();
      setAppointments(data || []);
    } catch (error) { console.error("Fetch Error:", error); }
  };

  // --- HELPERS ---
  const getNowInTimezone = () => {
    return new Date(new Date().toLocaleString("en-US", { timeZone: timezone }));
  };

  const appointmentsWithColors = appointments.map(apt => {
    const service = services.find(s => s.name === apt.serviceName);
    return { ...apt, color: service?.color || 'emerald' };
  });

  const weekStart = startOfWeek(selectedDate, { weekStartsOn: 0 });
  const weekEnd = endOfWeek(selectedDate, { weekStartsOn: 0 });
  const filteredAppointments = appointmentsWithColors.filter(apt => {
    const date = new Date(apt.startTime);
    return date >= weekStart && date <= weekEnd;
  });

  // --- HANDLERS (L√ìGICA RESTAURADA) ---

  // 1. Deletar Agendamento ou Bloqueio
  const handleQuickDelete = async (id) => {
    if (!confirm("Deseja realmente remover este item da agenda?")) return;
    try {
      await deleteAppointment(id);
      await refreshAppointments();
      setIsModalOpen(false);
    } catch (error) { alert("Erro ao deletar."); }
  };

  // 2. Salvar Agendamento Manual
  const handleSaveAppointment = async (formData) => {
    const { clientName, selectedServiceIds, time, notes, formDate } = formData;
    const selectedData = services.filter(s => selectedServiceIds.includes(s.id));
    
    if (selectedData.length === 0) return alert("Selecione ao menos um servi√ßo.");

    const totalDuration = selectedData.reduce((acc, s) => acc + s.duration, 0);
    const totalPrice = selectedData.reduce((acc, s) => acc + s.price, 0);
    const combinedServiceName = selectedData.map(s => s.name).join(' + ');
    const fullStartDateStr = `${format(formDate, 'yyyy-MM-dd')}T${time}:00`;

    setLoading(true);
    try {
      const aptData = {
        clientName, serviceName: combinedServiceName, price: totalPrice,
        duration: totalDuration, startTime: fullStartDateStr, notes,
        status: editingAppointment ? editingAppointment.status : 'scheduled'
      };
      
      if (editingAppointment) await updateAppointmentFull(editingAppointment.id, aptData);
      else await addAppointment(aptData);
      
      await refreshAppointments();
      setIsModalOpen(false);
    } catch (error) { alert("Erro ao salvar."); } 
    finally { setLoading(false); }
  };

  // 3. Salvar Bloqueio de Agenda
  const handleSaveBlock = async (formData) => {
    const { blockTime, blockDuration, blockRecurrence, blockOccurrences, blockNotes, formDate } = formData;
    const fullStartDateStr = `${format(formDate, 'yyyy-MM-dd')}T${blockTime}:00`;
    
    setLoading(true);
    try {
      await addBlockedTime({
        startTime: fullStartDateStr, 
        duration: parseInt(blockDuration), 
        notes: blockNotes,
        recurrence: blockRecurrence, 
        occurrences: parseInt(blockOccurrences)
      });
      await refreshAppointments();
      setIsBlockModalOpen(false);
    } catch (error) { alert("Erro ao bloquear hor√°rio."); }
    finally { setLoading(false); }
  };

  return (
    <AppLayout>
      {/* HEADER PREMIUM */}
      <div className="flex items-center justify-between mb-6 bg-white p-4 rounded-[24px] border border-schedy-border shadow-sm">
        <div className="flex items-center gap-6">
          <div>
            <h1 className="text-xl font-black uppercase italic tracking-tighter text-schedy-black leading-none">
              {profile?.barberShopName || 'Schedule'}
            </h1>
            <p className="text-[10px] font-bold text-schedy-gray uppercase tracking-widest mt-1 flex items-center gap-1">
              <Sun size={10} /> {profile?.country === 'PT' ? 'Lisbon' : 'Miami'} Time
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button 
            onClick={() => { setModalInitialDate(selectedDate); setIsBlockModalOpen(true); }}
            className="flex items-center gap-2 px-4 h-12 bg-schedy-canvas text-schedy-black rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-schedy-black hover:text-white transition-all"
          >
            <Lock size={14} /> Block
          </button>
          <Button 
            onClick={() => { setEditingAppointment(null); setModalInitialDate(getNowInTimezone()); setIsModalOpen(true); }}
            className="w-auto px-6 h-12 shadow-vivid"
          >
            <Plus size={18} className="mr-2" /> New Booking
          </Button>
        </div>
      </div>

      {/* CALEND√ÅRIO 7 DIAS */}
      <div className="flex-1 min-h-0">
        <DayView 
          appointments={filteredAppointments} 
          onAppointmentMove={async (id, newStart) => {
             await updateAppointmentTime(id, newStart);
             refreshAppointments();
          }}
          onAppointmentClick={(apt) => {
            if (apt.type === 'block') return handleQuickDelete(apt.id);
            setEditingAppointment(apt);
            setIsModalOpen(true);
          }}
          onTimeSlotClick={(date) => {
            setEditingAppointment(null);
            setModalInitialDate(date);
            setIsModalOpen(true);
          }} 
          onNavigate={setSelectedDate}
          startDate={selectedDate} 
          businessHours={businessHours}
          timezone={timezone} 
        />
      </div>

      {/* MODAL DE AGENDAMENTO */}
      <AppointmentModal 
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        editingAppointment={editingAppointment}
        services={services}
        currency={profile?.currency || '$'}
        onSave={handleSaveAppointment}
        onDelete={handleQuickDelete}
        initialDate={modalInitialDate}
        loading={loading}
      />

      {/* MODAL DE BLOQUEIO */}
      <BlockModal 
        isOpen={isBlockModalOpen}
        onClose={() => setIsBlockModalOpen(false)}
        onSave={handleSaveBlock}
        initialDate={modalInitialDate}
        loading={loading}
      />
    </AppLayout>
  );
}
```


--- ARQUIVO: src/pages/Services.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { Button } from '../components/ui/Button';
import { Input } from '../components/ui/Input';
import { Modal } from '../components/ui/Modal';
import { Plus, Trash2, Clock, DollarSign, Pencil, Check } from 'lucide-react'; 
import { 
    addService, 
    getServices, 
    deleteService, 
    updateService, 
    getProfessionalProfile 
} from '../services/professionalService'; 

// Paleta definida no tailwind.config.js
const SERVICE_COLORS = [
  { id: 'emerald', bg: 'bg-service-emerald', label: 'Verde' },
  { id: 'amber',   bg: 'bg-service-amber',   label: 'Amarelo' },
  { id: 'indigo',  bg: 'bg-service-indigo',  label: 'Roxo' },
  { id: 'rose',    bg: 'bg-service-rose',    label: 'Rosa' },
  { id: 'violet',  bg: 'bg-service-violet',  label: 'Violeta' },
  { id: 'sky',     bg: 'bg-service-sky',     label: 'Azul' },
  { id: 'orange',  bg: 'bg-service-orange',  label: 'Laranja' },
];

export function Services() {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [services, setServices] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currency, setCurrency] = useState('$');
  
  // Estados do Formul√°rio
  const [editingService, setEditingService] = useState(null); 
  const [name, setName] = useState('');
  const [price, setPrice] = useState('');
  const [duration, setDuration] = useState('30');
  const [color, setColor] = useState('emerald'); // Cor padr√£o
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    loadServices();
  }, []);

  const loadServices = async () => {
    try {
      const profile = await getProfessionalProfile();
      if (profile?.currency) setCurrency(profile.currency);
      
      const data = await getServices();
      setServices(data);
    } catch (error) {
      console.error("Error loading services:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleNewService = () => {
    setEditingService(null);
    setName('');
    setPrice('');
    setDuration('30');
    setColor('emerald');
    setIsModalOpen(true);
  };

  const handleEditService = (service) => {
    setEditingService(service);
    setName(service.name);
    setPrice(service.price.toString());
    setDuration(service.duration.toString());
    setColor(service.color || 'emerald');
    setIsModalOpen(true);
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSaving(true);
    try {
      const serviceData = {
        name,
        price: parseFloat(price),
        duration: parseInt(duration),
        color // Salvamos a cor escolhida
      };

      if (editingService) {
        await updateService(editingService.id, serviceData);
      } else {
        await addService(serviceData);
      }
      
      setIsModalOpen(false);
      loadServices(); 
    } catch (error) {
      alert("Error saving service");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    if (confirm("Deseja realmente excluir este servi√ßo?")) {
      await deleteService(id);
      loadServices();
    }
  };

  return (
    <AppLayout>
      <header className="flex items-center justify-between mb-10">
        <div>
          <h1 className="text-3xl font-black text-schedy-black tracking-tighter uppercase italic">Meus Servi√ßos</h1>
          <p className="text-schedy-gray text-xs font-bold uppercase tracking-widest">Cat√°logo e Precifica√ß√£o</p>
        </div>
        <Button className="w-auto gap-2 h-12 px-6 shadow-vivid" onClick={handleNewService}>
          <Plus size={20} /> Novo Servi√ßo
        </Button>
      </header>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {loading ? (
          <div className="col-span-3 py-20 flex justify-center">
            <div className="w-8 h-8 border-4 border-schedy-black border-t-transparent rounded-full animate-spin"></div>
          </div>
        ) : services.length === 0 ? (
          <div className="col-span-3 text-center py-20 bg-white border-2 border-dashed border-schedy-border rounded-[32px]">
            <p className="text-schedy-gray font-bold uppercase tracking-widest text-sm">Nenhum servi√ßo cadastrado.</p>
          </div>
        ) : (
          services.map((service) => (
            <div 
              key={service.id} 
              className="bg-white border border-schedy-border p-6 rounded-[32px] flex justify-between items-center group hover:shadow-premium transition-all relative overflow-hidden"
            >
              {/* Barra de cor lateral - O toque UAU */}
              <div className={`absolute left-0 top-0 bottom-0 w-2 bg-service-${service.color || 'emerald'}`} />

              <div className="pl-2">
                <h3 className="font-black text-schedy-black text-xl tracking-tight uppercase italic">{service.name}</h3>
                <div className="flex gap-4 mt-3 text-xs font-black uppercase tracking-widest">
                  <span className={`text-service-${service.color || 'emerald'} flex items-center gap-1`}>
                    {currency}{service.price}
                  </span>
                  <span className="text-schedy-gray flex items-center gap-1">
                    <Clock size={14}/> {service.duration} MIN
                  </span>
                </div>
              </div>
              
              <div className="flex gap-2">
                <button 
                  onClick={() => handleEditService(service)}
                  className="p-3 bg-schedy-canvas text-schedy-black rounded-2xl hover:bg-schedy-black hover:text-white transition-all"
                >
                  <Pencil size={18} />
                </button>
                <button 
                  onClick={() => handleDelete(service.id)}
                  className="p-3 bg-red-50 text-schedy-danger rounded-2xl hover:bg-schedy-danger hover:text-white transition-all"
                >
                  <Trash2 size={18} />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      <Modal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)}
        title={editingService ? "Editar Servi√ßo" : "Novo Servi√ßo"}
      >
        <form onSubmit={handleSave} className="flex flex-col gap-6">
          <Input 
            label="Nome do Servi√ßo" 
            placeholder="Ex: Corte Degrad√™" 
            value={name}
            onChange={e => setName(e.target.value)}
            required
          />
          
          <div className="flex gap-4">
            <Input 
              label={`Pre√ßo (${currency})`} 
              type="number" 
              step="0.01" 
              placeholder="30.00" 
              value={price}
              onChange={e => setPrice(e.target.value)}
              required
            />
            <div className="w-full">
              <label className="text-[10px] text-schedy-gray font-black uppercase tracking-widest mb-2 block">Dura√ß√£o</label>
              <select 
                className="w-full bg-schedy-canvas border border-schedy-border rounded-xl p-3 text-sm font-bold focus:border-schedy-black outline-none appearance-none"
                value={duration}
                onChange={e => setDuration(e.target.value)}
              >
                {[15, 30, 45, 60, 90, 120].map(m => (
                    <option key={m} value={m}>{m === 60 ? '1 HORA' : m > 60 ? '1H 30MIN' : `${m} MIN`}</option>
                ))}
              </select>
            </div>
          </div>

          {/* SELETOR DE CORES VIVAS */}
          <div>
            <label className="text-[10px] text-schedy-gray font-black uppercase tracking-widest mb-3 block">Identificador Visual (Cor do Card)</label>
            <div className="grid grid-cols-7 gap-3">
              {SERVICE_COLORS.map((c) => (
                <button
                  key={c.id}
                  type="button"
                  onClick={() => setColor(c.id)}
                  className={`
                    h-10 rounded-xl transition-all flex items-center justify-center
                    ${c.bg} 
                    ${color === c.id ? 'ring-4 ring-schedy-black scale-110 shadow-lg' : 'opacity-60 hover:opacity-100'}
                  `}
                >
                  {color === c.id && <Check size={20} className="text-white" />}
                </button>
              ))}
            </div>
          </div>

          <Button type="submit" loading={saving} className="mt-4 h-16 text-lg font-black uppercase italic tracking-tighter shadow-vivid">
            {editingService ? "Atualizar Cat√°logo" : "Salvar Servi√ßo"}
          </Button>
        </form>
      </Modal>
    </AppLayout>
  );
}
```


--- ARQUIVO: src/pages/Profile.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { ProfileDetails } from '../components/profile/ProfileDetails'; 
import { useAuth } from '../contexts/AuthContext'; 
import { getProfessionalProfile, updateProfessionalProfile } from '../services/professionalService'; 
import { getSalespersonProfile } from '../services/salesService';
import { updateSalesperson, requestAccountClosure } from '../services/adminService'; 
import { Globe, ShieldCheck, Zap } from 'lucide-react';

// CONSTANTES DE CONFIGURA√á√ÉO DE PA√çS (Sincronizado com Backend & IA)
const COUNTRY_CONFIG = {
  US: { name: 'United States', ddi: '1', currency: '$', flag: 'üá∫üá∏' },
  BR: { name: 'Brazil', ddi: '55', currency: 'R$', flag: 'üáßüá∑' },
  PT: { name: 'Portugal', ddi: '351', currency: '‚Ç¨', flag: 'üáµüáπ' },
  ES: { name: 'Espa√±a', ddi: '34', currency: '‚Ç¨', flag: 'üá™üá∏' },
  FR: { name: 'France', ddi: '33', currency: '‚Ç¨', flag: 'üá´üá∑' },
  IT: { name: 'Italia', ddi: '39', currency: '‚Ç¨', flag: 'üáÆüáπ' },
  GB: { name: 'United Kingdom', ddi: '44', currency: '¬£', flag: 'üá¨üáß' }
};

export function Profile() {
  const { user, profile: globalProfile } = useAuth(); 
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [closing, setClosing] = useState(false);
  const [role, setRole] = useState('professional'); 

  // Estados do Perfil
  const [country, setCountry] = useState('US');
  const [timezone, setTimezone] = useState('America/New_York'); 
  const [barberShopName, setBarberShopName] = useState('');
  const [whatsapp, setWhatsapp] = useState('');
  const [conciergeNumber, setConciergeNumber] = useState(''); 
  const [address, setAddress] = useState('');
  const [email, setEmail] = useState(''); 
  const [slug, setSlug] = useState('');
  
  // Estados de Hor√°rio de Funcionamento (Fundamentais para a IA)
  const [openTime, setOpenTime] = useState('09:00');
  const [closeTime, setCloseTime] = useState('18:00');
  const [breakTime, setBreakTime] = useState('12:00-13:00');
  const [workDays, setWorkDays] = useState([1, 2, 3, 4, 5]);

  const [aiPreference, setAiPreference] = useState('professional');

  useEffect(() => {
    if (user) {
      loadProfile();
    }
  }, [user]);

  const loadProfile = async () => {
    if (!user) return;
    try {
      let data = await getProfessionalProfile();
      
      if (data) {
        setRole(data.role === 'admin' ? 'admin' : 'professional');
      } else {
        data = await getSalespersonProfile(user.uid);
        if (data) setRole('sales');
      }

      if (data) {
        setBarberShopName(data.barberShopName || data.name || '');
        
        // L√≥gica de Identidade do N√∫mero: Se for Pro e tiver Concierge, exibimos separado
        if (data.phone && data.numberType === 'international_concierge') {
           setConciergeNumber(data.phone);
           // O campo 'whatsapp' aqui refere-se ao n√∫mero PESSOAL para notifica√ß√µes de transbordo
           setWhatsapp(data.personalPhone || ''); 
        } else {
           setWhatsapp(data.phone || '');
        }

        setAddress(data.address || '');
        setEmail(data.email || '');
        setCountry(data.country || 'US');
        setTimezone(data.timezone || 'America/New_York'); 
        setSlug(data.slug || '');
        
        if (data.settings?.businessHours) {
          setOpenTime(data.settings.businessHours.open || '09:00');
          setCloseTime(data.settings.businessHours.close || '18:00');
          setBreakTime(data.settings.businessHours.break || '12:00-13:00');
          if (Array.isArray(data.settings.businessHours.days)) {
            setWorkDays(data.settings.businessHours.days);
          }
        }
        setAiPreference(data.settings?.aiPreference || 'professional');
      }
    } catch (error) {
      console.error("Critical error in loadProfile:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleCountryChange = (e) => setCountry(e.target.value);
  
  const handlePhoneChange = (e) => {
    const value = e.target.value.replace(/\D/g, "");
    setWhatsapp(value); 
  };

  const handleSlugChange = (e) => {
    // Sanitiza√ß√£o de Slug: Apenas letras, n√∫meros e h√≠fens.
    const value = e.target.value
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // Remove acentos
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');
    setSlug(value);
  };

  const toggleDay = (dayIndex) => {
    setWorkDays(prev => {
      const newDays = prev.includes(dayIndex)
        ? prev.filter(d => d !== dayIndex)
        : [...prev, dayIndex].sort((a, b) => a - b);
      return newDays;
    });
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSaving(true);
    const config = COUNTRY_CONFIG[country];
    
    try {
      const payload = {
        barberShopName, 
        address, 
        country,
        currency: config.currency, 
        timezone, 
        ddi: config.ddi, 
        slug,
        updatedAt: new Date().toISOString()
      };

      if (role === 'professional' || role === 'admin') {
        // Para profissionais, salvamos o n√∫mero pessoal separadamente do Concierge
        if (conciergeNumber) {
          payload.personalPhone = whatsapp; 
        } else {
          payload.phone = whatsapp;
        }

        payload.settings = { 
          aiPreference, 
          businessHours: { 
            open: openTime, 
            close: closeTime, 
            break: breakTime,
            days: workDays 
          } 
        };
        await updateProfessionalProfile(payload);
      } else {
        // L√≥gica de Vendedor
        await updateSalesperson(user.uid, {
          name: barberShopName, phone: whatsapp, country, timezone, ddi: config.ddi
        });
      }
      alert("Success: Profile and AI logic updated.");
    } catch (error) { 
      alert("Error saving: Check your internet connection."); 
    } finally { 
      setSaving(false); 
    }
  };

  const handleCloseAccount = async () => {
    const confirmText = role === 'professional' 
      ? "CRITICAL: This will deactivate your International AI Concierge and your US number. Proceed?"
      : "WARNING: This will request account closure. Commissions will stop immediately. Proceed?";

    if (!confirm(confirmText)) return;
    setClosing(true);
    try {
      await requestAccountClosure(user.uid, role); 
      alert("Request received. Our team will contact you via email shortly.");
    } catch (error) { 
      alert("Error processing request. Contact support@schedy.ai"); 
    } finally { 
      setClosing(false); 
    }
  };

  const getPageTitle = () => {
    if (role === 'admin') return 'System Administrator';
    if (role === 'sales') return 'Partner Management';
    return 'Professional Console';
  };

  return (
    <AppLayout>
      <header className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter flex items-center gap-2">
            <Zap className="text-barber-gold" size={24} />
            {getPageTitle()}
          </h1>
          <p className="text-barber-gray font-bold uppercase tracking-widest text-[10px] opacity-70 italic">
            Configuring global business rules for Schedy AI
          </p>
        </div>
        
        {globalProfile?.plan === 'pro' && (
          <div className="flex items-center gap-2 bg-barber-gold/10 px-4 py-2 rounded-xl border border-barber-gold/20">
            <ShieldCheck size={16} className="text-barber-gold" />
            <span className="text-[10px] font-black text-barber-gold uppercase tracking-widest italic">International DID Active</span>
          </div>
        )}
      </header>

      {loading ? (
        <div className="flex flex-col items-center justify-center py-20 gap-4">
          <div className="w-8 h-8 border-2 border-barber-gold border-t-transparent rounded-full animate-spin"></div>
          <p className="text-barber-gray font-black text-[10px] uppercase tracking-[0.3em] animate-pulse">Syncing Cloud Profile...</p>
        </div>
      ) : (
        <ProfileDetails 
          role={role}
          email={email}
          barberShopName={barberShopName} setBarberShopName={setBarberShopName}
          whatsapp={whatsapp} handlePhoneChange={handlePhoneChange}
          conciergeNumber={conciergeNumber}
          address={address} setAddress={setAddress}
          country={country} handleCountryChange={handleCountryChange}
          timezone={timezone} setTimezone={setTimezone}
          slug={slug} handleSlugChange={handleSlugChange}
          openTime={openTime} setOpenTime={setOpenTime}
          closeTime={closeTime} setCloseTime={setCloseTime}
          breakTime={breakTime} setBreakTime={setBreakTime}
          workDays={workDays} toggleDay={toggleDay}
          saving={saving}
          handleSave={handleSave}
          closing={closing}
          globalProfileStatus={globalProfile?.status}
          handleCloseAccount={handleCloseAccount}
        />
      )}
    </AppLayout>
  );
}
```


--- ARQUIVO: src/pages/Pricing.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { Button } from '../components/ui/Button';
import { Check, Zap, Globe, ShieldCheck } from 'lucide-react';
import { getProfessionalProfile } from '../services/professionalService'; 
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';

// Global Stripe Checkout Link with 30-day trial
const STRIPE_CHECKOUT_LINK = "https://buy.stripe.com/eVq3cp6Ly1NL9Mg1qRfnO03";

export function Pricing() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [country, setCountry] = useState('US');
  const [userPlan, setUserPlan] = useState('free');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadProfile() {
      try {
        const profile = await getProfessionalProfile();
        if (profile) {
          if (profile.country) setCountry(profile.country);
          if (profile.plan) setUserPlan(profile.plan);
        }
      } catch (error) {
        console.error("Error loading profile:", error);
      } finally {
        setLoading(false);
      }
    }
    loadProfile();
  }, []);

  const handleSubscribe = () => {
    if (userPlan === 'pro') {
      navigate('/setup-pro');
      return;
    }

    if (!user || !user.uid) {
        alert("Session Error: Please log in again.");
        return;
    }
    
    // Attach barber ID for automatic activation via Webhook
    const checkoutUrl = `${STRIPE_CHECKOUT_LINK}?client_reference_id=${user.uid}`;
    window.location.href = checkoutUrl;
  };

  const config = {
    US: { currency: '$', totalPlan: '29' },
    BR: { currency: 'R$', totalPlan: '97' },
    PT: { currency: '‚Ç¨', totalPlan: '19' }
  }[country] || { currency: '$', totalPlan: '29' };

  const plans = [
    {
      id: 'free',
      name: "Starter",
      price: `${config.currency}0`,
      description: "Basic management for solo professionals.",
      features: [
        "Manual Digital Calendar",
        "Unlimited Services",
        "Basic Business Profile",
        "Manual Appointment Entries"
      ],
      buttonText: userPlan === 'free' ? "Current Level" : "Basic Version",
      variant: userPlan === 'free' ? "ghost" : "ghost",
      action: () => {}
    },
    {
      id: 'pro',
      name: "AI Concierge",
      price: `${config.currency}${config.totalPlan}`,
      period: "/mo",
      description: "Complete automation with 30-day trial.",
      features: [
        "24/7 AI Receptionist (WhatsApp)",
        "Dedicated US (+1) Phone Number",
        "First 30 days FREE (Trial)",
        "Real-time Automated Booking",
        "Instant Global Activation"
      ],
      buttonText: userPlan === 'pro' ? "Go to Setup" : "Start 30-Day Free Trial",
      variant: "primary",
      highlight: true,
      action: handleSubscribe
    }
  ];

  return (
    <AppLayout>
      <header className="mb-12">
        <h1 className="text-4xl font-black text-barber-white tracking-tighter uppercase italic text-left">
          Choose Your <span className="text-barber-gold">Level</span>
        </h1>
        <p className="text-barber-gray mt-2 font-bold uppercase tracking-widest text-xs italic opacity-80 text-left">
          Scale your business with the power of US-based AI automation.
        </p>
      </header>

      {loading ? (
        <div className="flex justify-center py-20">
          <div className="w-10 h-10 border-4 border-barber-gold border-t-transparent rounded-full animate-spin"></div>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
          {plans.map((plan) => (
            <div 
              key={plan.id} 
              className={`
                relative bg-barber-black p-8 rounded-3xl border transition-all duration-300 flex flex-col
                ${plan.highlight 
                  ? 'border-barber-gold shadow-[0_0_40px_rgba(197,160,89,0.15)] scale-105 z-10' 
                  : 'border-zinc-800 opacity-90 hover:opacity-100'
                }
              `}
            >
              {plan.highlight && (
                <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-barber-gold text-black px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">
                  Ready for Global Authority
                </div>
              )}

              <div className="mb-8 text-left">
                <h2 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter mb-1">{plan.name}</h2>
                <div className="flex items-baseline gap-1">
                  <span className="text-5xl font-black text-barber-white tracking-tighter">{plan.price}</span>
                  <span className="text-barber-gray font-bold text-sm uppercase">{plan.period}</span>
                </div>
                <p className="text-sm text-barber-gray mt-3 font-medium leading-relaxed italic">{plan.description}</p>
              </div>
              
              <ul className="space-y-4 mb-10 flex-1">
                {plan.features.map(f => (
                  <li key={f} className="flex items-start gap-3 text-sm text-barber-white/90 font-bold uppercase tracking-tight italic text-left">
                    <Check size={18} className="text-barber-gold shrink-0 mt-0.5" /> 
                    <span>{f}</span>
                  </li>
                ))}
              </ul>

              <Button 
                variant={plan.variant} 
                onClick={plan.action}
                disabled={plan.id === 'free' && userPlan === 'free'}
                className={`h-14 text-lg font-black uppercase tracking-tighter italic ${plan.highlight ? 'shadow-xl shadow-barber-red/20' : ''}`}
              >
                {plan.buttonText}
              </Button>

              {plan.highlight && (
                <div className="mt-6 flex items-center justify-center gap-4 text-zinc-600">
                   <div className="flex items-center gap-1 text-[10px] font-bold uppercase tracking-widest">
                      <Globe size={12} /> US Virtual DID
                   </div>
                   <div className="flex items-center gap-1 text-[10px] font-bold uppercase tracking-widest">
                      <ShieldCheck size={12} /> Secure Stripe
                   </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      <div className="mt-16 p-8 bg-zinc-900/30 border border-zinc-800 rounded-2xl text-center max-w-3xl mx-auto">
        <h3 className="text-white font-bold mb-2 uppercase tracking-tighter italic">Why the International Concierge?</h3>
        <p className="text-zinc-500 text-sm leading-relaxed font-medium italic">
          By utilizing our <span className="text-barber-gold font-bold italic">US Virtual DID System</span>, we bypass local bureaucratic hurdles. 
          Your international (+1) line is activated instantly, allowing your AI to serve clients and handle WhatsApp bookings with global stability and premium authority.
        </p>
      </div>
    </AppLayout>
  );
}
```


--- ARQUIVO: src/pages/SetupPro.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { Button } from '../components/ui/Button';
import { 
  Globe, 
  Loader2, 
  Copy, 
  Check, 
  Download,
  Zap,
  MapPin,
  ExternalLink,
  ShieldCheck,
  QrCode
} from 'lucide-react';
import { QRCodeCanvas } from 'qrcode.react'; 
import { provisionConciergeNumber, getProfessionalProfile } from '../services/professionalService'; 

const US_AREA_CODES = [
  { code: '305', city: 'Miami, FL' },
  { code: '212', city: 'New York, NY' },
  { code: '407', city: 'Orlando, FL' },
  { code: '702', city: 'Las Vegas, NV' },
  { code: '832', city: 'Houston, TX' },
  { code: 'random', city: 'Aloca√ß√£o Instant√¢nea' },
];

const COUNTRY_MESSAGES = {
  US: { text: "Hello! I'd like to schedule an appointment with {NAME}.", lang: "en" },
  BR: { text: "Ol√°! Gostaria de agendar um hor√°rio com {NAME}.", lang: "pt-BR" },
  PT: { text: "Ol√°! Gostaria de marcar um servi√ßo com {NAME}.", lang: "pt-PT" },
};

const CONCIERGE_NUMBER = "+14454563363"; 

export function SetupPro() {
  const [profile, setProfile] = useState(null);
  const [pageLoading, setPageLoading] = useState(true);
  const [activationLoading, setActivationLoading] = useState(false);
  const [isActivated, setIsActivated] = useState(false); 
  const [copied, setCopied] = useState(false); 
  const [selectedAreaCode, setSelectedAreaCode] = useState('random');

  useEffect(() => {
    async function loadProfile() {
      try {
        const data = await getProfessionalProfile();
        if (data && data.plan === 'pro') {
          setProfile(data);
          if (data.numberActivatedAt && data.numberCountry === 'US') {
             setIsActivated(true);
          }
        }
      } catch (error) { console.error(error); } finally { setPageLoading(false); }
    }
    loadProfile();
  }, []);

  const handleActivate = async () => {
    setActivationLoading(true);
    try {
      await provisionConciergeNumber({ areaCode: selectedAreaCode }); 
      setIsActivated(true);
    } catch (error) { alert("Erro na ativa√ß√£o."); } finally { setActivationLoading(false); }
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (pageLoading) {
    return (
      <AppLayout>
        <div className="flex flex-col items-center justify-center py-40 gap-4">
          <Loader2 className="animate-spin text-schedy-black" size={48} />
          <p className="text-schedy-gray font-black uppercase tracking-[0.3em] text-[10px]">Configurando Infraestrutura US...</p>
        </div>
      </AppLayout>
    );
  }

  if (!profile || profile.plan !== 'pro') {
     return (
      <AppLayout>
        <div className="max-w-md mx-auto mt-20 text-center bg-white border border-schedy-border p-12 rounded-[40px] shadow-premium">
          <Zap className="text-schedy-black mx-auto mb-6" size={48} />
          <h2 className="text-schedy-black font-black text-2xl mb-3 uppercase italic tracking-tighter">Plano Pro Necess√°rio</h2>
          <p className="text-schedy-gray text-sm mb-8 font-medium leading-relaxed">Voc√™ precisa de um plano ativo para provisionar seu n√∫mero internacional e ativar a IA.</p>
          <Button onClick={() => window.location.href = '/pricing'}>Ver Planos</Button>
        </div>
      </AppLayout>
     );
  }

  const identifier = profile.slug || profile.id;
  const businessName = profile.barberShopName || profile.name;
  const localeConfig = COUNTRY_MESSAGES[profile.country] || COUNTRY_MESSAGES.US;
  const localizedText = localeConfig.text.replace('{NAME}', businessName);
  const initialMessage = `${localizedText} (ID: ${identifier})`;
  const cleanConcierge = CONCIERGE_NUMBER.replace(/\D/g, '');
  const whatsappLink = `https://wa.me/${cleanConcierge}?text=${encodeURIComponent(initialMessage)}`;

  const PageHeader = (
    <header className="flex items-center justify-between mb-8 bg-white p-6 rounded-[24px] border border-schedy-border shadow-sm">
        <div className="flex items-center gap-4">
          <div className="bg-schedy-black p-2.5 rounded-xl text-white">
            <Globe size={20} />
          </div>
          <div>
            <h1 className="text-xl font-black text-schedy-black tracking-tighter uppercase italic leading-none">AI Concierge</h1>
            <p className="text-[10px] font-bold text-schedy-gray uppercase tracking-widest mt-1">Status da Opera√ß√£o Internacional</p>
          </div>
        </div>
        {isActivated && (
          <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-xl border border-green-100">
            <span className="w-2 h-2 bg-green-500 rounded-full animate-ping" />
            <span className="text-[10px] font-black uppercase text-green-600 italic">Live & Active</span>
          </div>
        )}
    </header>
  );

  if (!isActivated) {
    return (
        <AppLayout>
            {PageHeader}
            <div className="max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div className="bg-white border-2 border-schedy-border p-10 rounded-[48px] shadow-premium relative overflow-hidden text-center">
                    <div className="mb-10">
                      <h2 className="text-4xl font-black text-schedy-black tracking-tighter uppercase italic mb-4">
                        Ative sua Autoridade <span className="text-service-indigo">Global</span>
                      </h2>
                      <p className="text-schedy-gray font-medium max-w-lg mx-auto">
                        Seu Concierge ser√° provisionado instantaneamente com uma linha virtual dos Estados Unidos (+1) para m√°xima estabilidade.
                      </p>
                    </div>

                    <div className="bg-schedy-canvas/50 p-8 rounded-[32px] border border-schedy-border mb-10 text-left">
                      <label className="text-[10px] font-black text-schedy-black uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                        <MapPin size={12} /> Selecione o C√≥digo de √Årea (EUA)
                      </label>
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {US_AREA_CODES.map((item) => (
                          <button
                            key={item.code}
                            type="button"
                            onClick={() => setSelectedAreaCode(item.code)}
                            className={`p-5 rounded-2xl border-2 transition-all duration-300 text-left ${
                              selectedAreaCode === item.code 
                              ? 'bg-schedy-black border-schedy-black text-white shadow-vivid scale-105' 
                              : 'bg-white border-schedy-border text-schedy-gray hover:border-schedy-black hover:text-schedy-black'
                            }`}
                          >
                            <p className="text-2xl font-black italic">{item.code === 'random' ? 'ANY' : item.code}</p>
                            <p className="text-[9px] font-bold uppercase opacity-80">{item.city}</p>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    <Button 
                        onClick={handleActivate} 
                        loading={activationLoading} 
                        className="h-20 text-xl shadow-vivid"
                    >
                        {activationLoading ? "Provisionando Linha US..." : "Ativar Concierge Internacional"}
                    </Button>
                </div>
            </div>
        </AppLayout>
    );
  }

  return (
    <AppLayout>
      {PageHeader}
      <div className="max-w-5xl mx-auto animate-in zoom-in-95 duration-500">
        <div className="bg-white border-2 border-schedy-black p-10 md:p-16 rounded-[60px] shadow-premium relative overflow-hidden">
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
            
            <div className="flex flex-col items-center">
                <div className="bg-schedy-canvas p-10 rounded-[48px] shadow-inner mb-8 relative group border border-schedy-border/50">
                    <div className="bg-white p-6 rounded-[32px] shadow-premium">
                      <QRCodeCanvas 
                          id="qr-concierge"
                          value={whatsappLink} 
                          size={240}
                          level={"H"}
                      />
                    </div>
                    <div className="absolute -top-4 -right-4 bg-schedy-black text-white p-4 rounded-full shadow-vivid rotate-12">
                      <QrCode size={24} />
                    </div>
                </div>
                <Button variant="outline" className="w-auto h-12 px-8" onClick={() => {
                    const canvas = document.getElementById('qr-concierge');
                    const url = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.download = `meu-concierge-ia.png`;
                    link.href = url;
                    link.click();
                }}>
                    <Download size={18} className="mr-2" /> Baixar Kit Digital (PNG)
                </Button>
            </div>

            <div className="space-y-8">
                <div>
                  <h2 className="text-4xl font-black text-schedy-black uppercase italic tracking-tighter mb-2">Concierge Ativo.</h2>
                  <p className="text-schedy-gray font-medium">Sua intelig√™ncia artificial j√° est√° operando na rede global do WhatsApp.</p>
                </div>

                <div className="bg-schedy-canvas p-6 rounded-[24px] border border-schedy-border/50">
                    {/* CORRE√á√ÉO: Removido 'block' aqui */}
                    <label className="text-[10px] font-black text-schedy-gray uppercase mb-3 tracking-widest italic flex items-center gap-2">
                      <ShieldCheck size={14} /> Linha Internacional Dedicada
                    </label>
                    <span className="text-4xl font-black text-schedy-black tracking-tighter italic">{CONCIERGE_NUMBER}</span>
                </div>

                <div className="bg-schedy-canvas p-6 rounded-[24px] border border-schedy-border/50">
                    {/* CORRE√á√ÉO: Removido 'block' aqui */}
                    <label className="text-[10px] font-black text-schedy-gray uppercase mb-3 tracking-widest italic flex items-center gap-2">
                      Your Smart Booking Link
                    </label>
                    <div className="flex items-center gap-3">
                        <div className="bg-white text-[10px] text-schedy-black w-full p-4 rounded-xl truncate font-mono border border-schedy-border shadow-sm italic">
                            {whatsappLink}
                        </div>
                        <button 
                            type="button"
                            onClick={() => copyToClipboard(whatsappLink)}
                            className="p-4 bg-schedy-black text-white rounded-2xl hover:scale-110 transition-all shadow-vivid shrink-0"
                        >
                            {copied ? <Check size={20} /> : <Copy size={20} />}
                        </button>
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row gap-4 pt-4">
                  <Button onClick={() => window.location.href = '/dashboard'} className="flex-1 h-16 shadow-vivid">
                    Gerenciar Agenda
                  </Button>
                  <Button 
                      onClick={() => window.open(whatsappLink, '_blank')} 
                      variant="outline" 
                      className="flex-1 h-16 gap-2"
                  >
                    Testar Chat IA <ExternalLink size={18} />
                  </Button>
                </div>
            </div>
          </div>
        </div>
      </div>
    </AppLayout>
  );
}

export default SetupPro;
```


--- ARQUIVO: src/pages/Admin.jsx ---
```javascript
import React, { useState, useEffect } from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { 
  Users, 
  Briefcase, 
  Bot, 
  Sparkles
} from 'lucide-react';
import { db } from '../services/firebase';
import { doc, getDoc, updateDoc } from 'firebase/firestore';
import { 
  getAllTenants, 
  getAllSalespeople, 
  getAllPayoutRequests
} from '../services/adminService';

// IMPORTA√á√ÉO DOS NOVOS COMPONENTES
import { AdminStats } from '../components/admin/AdminStats';
import { UsersTab } from '../components/admin/UsersTab';
import { CommercialTab } from '../components/admin/CommercialTab';
import { AiTrainingTab } from '../components/admin/AiTrainingTab';
import { SalespersonModal } from '../components/admin/SalespersonModal';

export function Admin() {
  // --- ESTADOS GERAIS ---
  const [activeTab, setActiveTab] = useState('users'); 
  const [loading, setLoading] = useState(true);
  
  // --- DADOS ---
  const [tenants, setTenants] = useState([]); 
  const [salespeople, setSalespeople] = useState([]);
  const [payoutRequests, setPayoutRequests] = useState([]);

  // --- ESTADOS DE FILTRO E MODAL ---
  const [searchTerm, setSearchTerm] = useState(''); // Busca de usu√°rios
  const [isSalesModalOpen, setIsSalesModalOpen] = useState(false);
  const [editingSalesperson, setEditingSalesperson] = useState(null);

  // --- ESTADOS DA IA ---
  const [aiConfig, setAiConfig] = useState({ additionalContext: '' });
  const [aiSaving, setAiSaving] = useState(false);

  // --- CARREGAMENTO INICIAL ---
  useEffect(() => {
    loadInitialData();
  }, []);

  const loadInitialData = async () => {
    setLoading(true);
    try {
      const [tenantsData, salesData, payoutsData] = await Promise.all([
        getAllTenants(),
        getAllSalespeople(),
        getAllPayoutRequests()
      ]);
      setTenants(tenantsData);
      setSalespeople(salesData);
      setPayoutRequests(payoutsData);
      await loadAIConfig();
    } catch (error) {
      console.error("Error loading admin data:", error);
    } finally {
      setLoading(false);
    }
  };

  const loadAIConfig = async () => {
    try {
      const docRef = doc(db, 'settings', 'ai_config');
      const snap = await getDoc(docRef);
      if (snap.exists()) setAiConfig({ additionalContext: snap.data().additionalContext || '' });
    } catch (error) { console.error(error); }
  };

  // --- HANDLERS ESPEC√çFICOS ---

  // Salvar Treinamento da IA
  const handleSaveAIConfig = async () => {
    setAiSaving(true);
    try {
      const docRef = doc(db, 'settings', 'ai_config');
      await updateDoc(docRef, { additionalContext: aiConfig.additionalContext, updatedAt: new Date().toISOString() });
      alert("AI Training saved!");
    } catch (error) { alert("Failed to save."); }
    finally { setAiSaving(false); }
  };

  // Abrir Modal de Cria√ß√£o
  const handleOpenCreateSales = () => {
    setEditingSalesperson(null);
    setIsSalesModalOpen(true);
  };

  // Abrir Modal de Edi√ß√£o
  const handleOpenEditSales = (person) => {
    setEditingSalesperson(person);
    setIsSalesModalOpen(true);
  };

  // C√°lculo de Estat√≠sticas para os Cards
  const stats = {
    total: tenants.length,
    pro: tenants.filter(t => t.plan === 'pro').length,
    salesCount: salespeople.length,
    pendingPayouts: payoutRequests.filter(p => p.status === 'pending').length
  };

  return (
    <AppLayout>
      <header className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter flex items-center gap-2">
            <Sparkles className="text-barber-gold" size={24} />
            Schedy Management
          </h1>
          <p className="text-barber-gray text-sm font-bold uppercase tracking-widest opacity-70">Owner Control Panel</p>
        </div>

        {/* NAVEGA√á√ÉO DE ABAS */}
        <div className="flex bg-zinc-900 p-1 rounded-xl border border-zinc-800">
          <TabButton active={activeTab === 'users'} onClick={() => setActiveTab('users')} icon={<Users size={16}/>} label="Users" />
          <TabButton active={activeTab === 'commercial'} onClick={() => setActiveTab('commercial')} icon={<Briefcase size={16}/>} label="Commercial" />
          <TabButton active={activeTab === 'ai'} onClick={() => setActiveTab('ai')} icon={<Bot size={16}/>} label="AI Training" />
        </div>
      </header>

      {/* CARDS DE ESTAT√çSTICA (GLOBAL) */}
      <AdminStats stats={stats} />

      {/* CONTE√öDO DAS ABAS */}
      {loading ? (
        <div className="p-10 text-center animate-pulse text-zinc-500 font-bold uppercase tracking-widest">Loading Dashboard...</div>
      ) : (
        <>
          {activeTab === 'users' && (
            <UsersTab 
              tenants={tenants} 
              searchTerm={searchTerm} 
              setSearchTerm={setSearchTerm} 
              onReload={loadInitialData} 
            />
          )}

          {activeTab === 'commercial' && (
            <CommercialTab 
              salespeople={salespeople} 
              payoutRequests={payoutRequests} 
              onReload={loadInitialData}
              onEditSalesperson={handleOpenEditSales}
              onOpenCreateSales={handleOpenCreateSales}
              pendingPayoutsCount={stats.pendingPayouts}
            />
          )}

          {activeTab === 'ai' && (
            <AiTrainingTab 
              aiConfig={aiConfig} 
              setAiConfig={setAiConfig} 
              onSave={handleSaveAIConfig} 
              saving={aiSaving} 
            />
          )}
        </>
      )}

      {/* MODAL DE VENDEDOR (COMPARTILHADO) */}
      <SalespersonModal 
        isOpen={isSalesModalOpen} 
        onClose={() => setIsSalesModalOpen(false)} 
        editingSalesperson={editingSalesperson}
        onSuccess={loadInitialData}
      />
    </AppLayout>
  );
}

// Bot√£o de Aba Auxiliar (Pequeno demais para extrair)
function TabButton({ active, onClick, icon, label }) {
  return (
    <button 
      onClick={onClick}
      className={`flex items-center gap-2 px-6 py-2 rounded-lg text-xs font-black uppercase tracking-widest transition-all ${
        active ? 'bg-barber-gold text-black shadow-lg' : 'text-zinc-500 hover:text-white'
      }`}
    >
      {icon} {label}
    </button>
  );
}
```


--- ARQUIVO: src/pages/Terms.jsx ---
```javascript
import React from 'react';
import { AppLayout } from '../components/ui/AppLayout';
import { Shield, Lock, FileCheck, Scale, Zap } from 'lucide-react';

export function Terms() {
  return (
    <AppLayout>
      <header className="mb-8">
        <h1 className="text-2xl font-black text-barber-white uppercase italic tracking-tighter">Legal Documentation</h1>
        <p className="text-barber-gray font-medium">Transparency and security for your business</p>
      </header>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* Summary Card */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="bg-zinc-900/50 border border-zinc-800 p-5 rounded-2xl flex items-start gap-4">
            <Shield className="text-barber-gold shrink-0" size={24} />
            <div>
              <h3 className="text-white font-bold text-sm uppercase tracking-tight">Data Protection (GDPR/LGPD)</h3>
              <p className="text-zinc-500 text-xs mt-1 leading-relaxed">Your data and your clients' data are encrypted, isolated, and never sold to third parties.</p>
            </div>
          </div>
          <div className="bg-zinc-900/50 border border-zinc-800 p-5 rounded-2xl flex items-start gap-4">
            <Lock className="text-barber-gold shrink-0" size={24} />
            <div>
              <h3 className="text-white font-bold text-sm uppercase tracking-tight">Total Privacy</h3>
              <p className="text-zinc-500 text-xs mt-1 leading-relaxed">AI Concierge only monitors booking-related messages. Personal chats remain private.</p>
            </div>
          </div>
        </div>

        {/* The Document Itself */}
        <div className="bg-barber-black border border-zinc-800 rounded-3xl overflow-hidden shadow-2xl">
          <div className="bg-zinc-900 px-8 py-5 border-b border-zinc-800 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <FileCheck size={18} className="text-barber-gold" />
              <span className="text-xs font-bold text-barber-gray uppercase tracking-[0.2em]">Service Agreement</span>
            </div>
            <span className="text-[10px] font-black text-barber-gold bg-barber-gold/10 px-3 py-1 rounded-full uppercase italic">v1.1 - 30-Day Trial Update</span>
          </div>
          
          <div className="p-8 text-barber-gray text-sm leading-relaxed space-y-8 overflow-y-auto max-h-[60vh] custom-scrollbar italic font-medium">
            
            <section>
              <h2 className="text-barber-white font-black text-lg mb-3 flex items-center gap-2 uppercase tracking-tighter">
                <Scale size={18} className="text-barber-gold" /> 1. Terms of Use
              </h2>
              <p>By using Schedy AI (operating as 'AI Concierge'), you agree to provide accurate information about your business. The system is an automated tool designed to assist professional barbers and stylists with scheduling and client communication via WhatsApp.</p>
            </section>

            <section>
              <h2 className="text-barber-white font-black text-lg mb-3 uppercase tracking-tighter italic">2. 30-Day Free Trial & Subscriptions</h2>
              <p>New subscribers to the <strong>Full Plan (AI Concierge)</strong> are entitled to a <strong>30-day free trial period</strong>. You may cancel your subscription at any time during this period through your dashboard or Stripe portal without being charged the monthly subscription fee.</p>
              
              <div className="bg-barber-red/5 border-l-4 border-barber-red p-4 my-4">
                <p className="text-barber-white font-bold italic text-xs">
                  "Note: The Setup/Activation Fee is non-refundable. This fee covers the immediate reservation of your dedicated US (+1) infrastructure and official WhatsApp API channel allocation, which are provided instantly upon registration."
                </p>
              </div>
            </section>

            <section>
              <h2 className="text-barber-white font-black text-lg mb-3 uppercase tracking-tighter italic">3. Data Responsibility</h2>
              <p>Schedy AI acts as the Data <strong>Processor</strong>. The Professional (Tenant) is the Data <strong>Controller</strong>, responsible for ensuring that clients are aware that their scheduling intentions are processed via Artificial Intelligence for business efficiency.</p>
            </section>

            <section>
              <h2 className="text-barber-white font-black text-lg mb-3 uppercase tracking-tighter italic">4. AI Privacy Policy</h2>
              <p>We utilize the Google Gemini API to process and understand booking requests. Conversation data is strictly used for real-time scheduling and is NOT used for public AI model training, preserving your commercial secrets and client privacy.</p>
            </section>

            <div className="pt-10 border-t border-zinc-800 text-center space-y-2">
              <p className="text-[10px] font-bold uppercase tracking-widest">Last Updated: February 11, 2026</p>
              <p className="text-[10px] font-black text-barber-gold uppercase tracking-widest italic flex items-center justify-center gap-2">
                <Zap size={10} fill="currentColor" /> Schedy AI Inc. ‚Ä¢ US International Division
              </p>
            </div>
          </div>
        </div>
      </div>
    </AppLayout>
  );
}
```


--- ARQUIVO: src/components/ui/Sidebar.jsx ---
```javascript
import React from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { 
  Calendar, LogOut, User, Zap, ShieldAlert, FileText, 
  Briefcase, Users, MessageSquare, Sparkles, BarChart3, 
  CreditCard, TrendingUp, HelpCircle, X, Bell, QrCode,
  ChevronRight, ChevronLeft, Menu
} from 'lucide-react';
import { signOut } from 'firebase/auth';
import { auth } from '../../services/firebase';
import { useAuth } from '../../contexts/AuthContext'; 
import { PWAInstallButton } from './PWAInstallButton';

export function Sidebar({ isCollapsed, toggleCollapse, onCloseMobile }) {
  const location = useLocation(); 
  const navigate = useNavigate();
  const { profile } = useAuth(); 

  const isAdmin = profile?.role === 'admin';
  const isPro = profile?.plan === 'pro';
  const isSales = profile?.role === 'sales';

  let menuItems = [];

  if (isAdmin) {
    menuItems = [
      { path: '/admin', icon: ShieldAlert, label: 'Management' },      
      { path: '/admin-dashboard', icon: BarChart3, label: 'Analytics' },
      { path: '/profile', icon: User, label: 'Settings' },
    ];
  } else if (isSales) {
    menuItems = [
      { path: '/sales-console', icon: TrendingUp, label: 'Dashboard' },
      { path: '/sales-crm', icon: Users, label: 'Network' },
      { path: '/sales-analytics', icon: BarChart3, label: 'Reports' },
      { path: '/profile', icon: User, label: 'Profile' },
    ];
  } else {
    menuItems = [
      { path: '/dashboard', icon: Calendar, label: 'Schedule' },
      { path: '/notifications', icon: Bell, label: 'Inbox' },
      { path: '/messages', icon: MessageSquare, label: 'Live Chat' },
      { path: '/customers', icon: Users, label: 'Customers' },
      { path: '/services', icon: Briefcase, label: 'Services' },
      { path: '/setup-pro', icon: QrCode, label: 'My QR' },
      { path: '/profile', icon: User, label: 'Profile' },
      isPro 
        ? { path: '/billing', icon: CreditCard, label: 'Billing' }
        : { path: '/pricing', icon: Zap, label: 'Plans' },
    ];
  }

  const handleLogout = async () => {
    await signOut(auth);
    navigate('/');
  };

  return (
    <div className="flex flex-col h-full bg-white relative">
      
      {/* Bot√£o para Expandir/Retrair (Apenas Desktop) */}
      <button 
        onClick={toggleCollapse}
        className="hidden lg:flex absolute -right-3 top-10 w-6 h-6 bg-schedy-black text-white rounded-full items-center justify-center shadow-vivid z-50 hover:scale-110 transition-transform"
      >
        {isCollapsed ? <ChevronRight size={14} /> : <ChevronLeft size={14} />}
      </button>

      {/* HEADER: LOGO */}
      <div className={`h-16 flex items-center ${isCollapsed ? 'justify-center' : 'px-6'} border-b border-schedy-border shrink-0`}>
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 bg-schedy-black text-white rounded-lg flex items-center justify-center font-black italic text-xs shrink-0">
            S
          </div>
          {!isCollapsed && (
            <span className="font-black text-xl tracking-tighter text-schedy-black animate-in fade-in slide-in-from-left-2">
              SCHEDY
            </span>
          )}
        </div>
      </div>

      {/* NAVEGA√á√ÉO */}
      <nav className="flex-1 py-6 flex flex-col gap-1 px-3 overflow-y-auto custom-scrollbar">
        {menuItems.map((item) => {
          const isActive = location.pathname === item.path;
          return (
            <Link
              key={item.path}
              to={item.path}
              onClick={onCloseMobile}
              title={isCollapsed ? item.label : ''}
              className={`
                flex items-center gap-3 px-3 py-3 rounded-xl transition-all duration-200 group
                ${isActive 
                  ? 'bg-schedy-black text-white shadow-vivid' 
                  : 'text-schedy-gray hover:bg-schedy-canvas hover:text-schedy-black'
                }
                ${isCollapsed ? 'justify-center' : 'justify-start'}
              `}
            >
              <item.icon size={20} className={isActive ? 'text-white' : 'group-hover:scale-110 transition-transform'} />
              {!isCollapsed && (
                <span className="font-bold uppercase tracking-tight text-[11px] whitespace-nowrap animate-in fade-in slide-in-from-left-2">
                  {item.label}
                </span>
              )}
            </Link>
          );
        })}
      </nav>

      {/* FOOTER: PROFILE & LOGOUT */}
      <div className="p-3 border-t border-schedy-border flex flex-col gap-2">
        
        {/* Profile Card */}
        <div className={`
          flex items-center gap-3 rounded-2xl transition-all
          ${isCollapsed ? 'justify-center p-1' : 'bg-schedy-canvas p-3'}
        `}>
          <div className={`
            rounded-xl flex items-center justify-center font-black text-white shadow-sm shrink-0
            ${isAdmin ? 'bg-schedy-danger' : 'bg-schedy-black'}
            ${isCollapsed ? 'w-10 h-10 text-xs' : 'w-9 h-9 text-[10px]'}
          `}>
            {profile?.name?.charAt(0).toUpperCase() || 'U'}
          </div>
          
          {!isCollapsed && (
            <div className="min-w-0 animate-in fade-in slide-in-from-left-2">
              <p className="text-[10px] font-black text-schedy-black uppercase truncate leading-tight">
                {profile?.name || 'User'}
              </p>
              <p className="text-[9px] text-schedy-gray truncate">
                {profile?.email}
              </p>
            </div>
          )}
        </div>

        <button 
          onClick={handleLogout}
          title={isCollapsed ? 'Log Out' : ''}
          className={`
            flex items-center gap-3 px-3 py-3 text-schedy-gray hover:text-schedy-danger hover:bg-red-50 rounded-xl transition-all font-bold uppercase text-[10px]
            ${isCollapsed ? 'justify-center' : 'justify-start'}
          `}
        >
          <LogOut size={20} />
          {!isCollapsed && <span className="animate-in fade-in slide-in-from-left-2">Sign Out</span>}
        </button>
      </div>
    </div>
  );
}
```


--- ARQUIVO: src/components/ui/AppLayout.jsx ---
```javascript
import React, { useState } from 'react';
import { Sidebar } from './Sidebar';
import { Menu } from 'lucide-react';
import { SupportChat } from './SupportChat';

export function AppLayout({ children }) {
  // Estado Desktop: Come√ßa fechada (apenas √≠cones) para foco total no conte√∫do
  const [isCollapsed, setIsCollapsed] = useState(true);
  
  // Estado Mobile: Controle do menu hamb√∫rguer (Overlay)
  const [isMobileOpen, setIsMobileOpen] = useState(false);

  const toggleSidebar = () => setIsCollapsed(!isCollapsed);

  return (
    // Fundo claro de alto contraste (schedy-canvas)
    <div className="flex h-screen bg-schedy-canvas text-schedy-black font-sans overflow-hidden">
      
      {/* Overlay Mobile: Escurece o fundo quando o menu abre no celular */}
      {isMobileOpen && (
        <div 
          className="fixed inset-0 bg-schedy-black/20 backdrop-blur-sm z-[60] lg:hidden"
          onClick={() => setIsMobileOpen(false)}
        />
      )}

      {/* 
          SIDEBAR CONTAINER 
          Z-Index alto (z-50) para garantir que fique acima de tudo, exceto modais.
      */}
      <aside 
        className={`
          fixed inset-y-0 left-0 z-50 h-full bg-white border-r border-schedy-border shadow-premium
          transition-all duration-300 ease-in-out
          /* Comportamento Mobile: Ocupa 280px e desliza */
          ${isMobileOpen ? 'translate-x-0 w-[280px]' : '-translate-x-full lg:translate-x-0'}
          /* Largura Din√¢mica no Desktop */
          lg:${isCollapsed ? 'w-[72px]' : 'w-[240px]'}
        `}
      >
        <Sidebar 
          isCollapsed={isCollapsed} 
          toggleCollapse={toggleSidebar}
          onCloseMobile={() => setIsMobileOpen(false)}
        />
      </aside>
      
      {/* 
          √ÅREA PRINCIPAL (MAIN)
          O segredo do Layout Enterprise: Margem din√¢mica (ml) no desktop.
          Isso impede que qualquer conte√∫do fique atr√°s da sidebar.
      */}
      <main 
        className={`
          flex-1 flex flex-col min-w-0 h-screen relative transition-all duration-300
          /* Margem √† esquerda que "empurra" o conte√∫do para fora da √°rea da sidebar */
          lg:${isCollapsed ? 'ml-[72px]' : 'ml-[240px]'}
        `}
      >
        
        {/* Header Mobile: Vis√≠vel apenas em telas pequenas */}
        <div className="lg:hidden h-16 bg-white border-b border-schedy-border flex items-center justify-between px-6 shrink-0 z-30">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-schedy-black text-white rounded-lg flex items-center justify-center font-black italic text-xs">
              S
            </div>
            <span className="font-black text-lg tracking-tighter text-schedy-black">SCHEDY</span>
          </div>
          <button 
            onClick={() => setIsMobileOpen(true)}
            className="p-2 hover:bg-schedy-canvas rounded-lg transition-colors text-schedy-black"
          >
            <Menu size={24} />
          </button>
        </div>

        {/* 
            VIEWPORT DE CONTE√öDO 
            Ocupa 100% da largura dispon√≠vel ap√≥s a margem da sidebar.
        */}
        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6 custom-scrollbar">
          <div className="w-full h-full flex flex-col">
            {children}
          </div>
        </div>
      </main>

      {/* Agente IA (Flutuante com Z-Index alt√≠ssimo) */}
      <div className="relative z-[100]">
        <SupportChat />
      </div>
    </div>
  );
}
```


--- ARQUIVO: src/components/ui/Modal.jsx ---
```javascript
import React, { useEffect } from 'react';
import { X } from 'lucide-react';

/**
 * Modal Component - Schedy Premium UI
 * Foco: Largura generosa (Wide Layout), Header/Footer fixos e Contraste M√°ximo.
 */
export function Modal({ isOpen, onClose, title, children, footer }) {
  
  // BLOQUEIO DE SCROLL DO FUNDO
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      
      {/* Overlay com Blur Elegante */}
      <div 
        className="absolute inset-0 bg-schedy-black/20 backdrop-blur-md transition-opacity"
        onClick={onClose}
      ></div>

      {/* 
         JANELA DO MODAL:
         - max-w-2xl: Aumentamos a largura para comportar agendamentos manuais
         - bg-white: Agora no padr√£o Light de alto contraste
      */}
      <div className="relative w-full max-w-2xl bg-white border border-schedy-border rounded-[32px] shadow-vivid flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-300 overflow-hidden">
        
        {/* 1. CABE√áALHO (FIXO) */}
        <div className="flex items-center justify-between p-8 border-b border-schedy-border bg-white z-10">
          <div className="flex flex-col">
            <h2 className="text-2xl font-black text-schedy-black uppercase italic tracking-tighter leading-none">
              {title}
            </h2>
            <div className="h-1 w-12 bg-schedy-black mt-2 rounded-full" />
          </div>
          
          <button 
            onClick={onClose}
            className="text-schedy-gray hover:text-schedy-black transition-all p-2 bg-schedy-canvas rounded-xl hover:rotate-90"
          >
            <X size={20} />
          </button>
        </div>

        {/* 2. √ÅREA DE CONTE√öDO (SCROLL INTERNO) */}
        <div className="flex-1 overflow-y-auto p-8 custom-scrollbar bg-white">
          <div className="space-y-6">
            {children}
          </div>
        </div>

        {/* 3. RODAP√â (FIXO - Se houver bot√µes passados via prop) */}
        {footer && (
          <div className="p-8 border-t border-schedy-border bg-schedy-canvas/30 z-10">
            {footer}
          </div>
        )}
      </div>
    </div>
  );
}
```


--- ARQUIVO: src/components/ui/Button.jsx ---
```javascript
import React from 'react';

/**
 * Button Component - Schedy Premium UI
 * Foco: Alto contraste, tipografia editorial e feedback t√°til.
 */
export function Button({ 
  children, 
  variant = 'primary', 
  loading, 
  className = '', 
  ...props 
}) {
  
  // Base: Cantos arredondados premium, tipografia it√°lica pesada e tracking apertado
  const baseStyles = "w-full py-4 px-6 rounded-2xl font-black uppercase italic tracking-tighter transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed active:scale-95 text-sm";
  
  const variants = {
    // Principal: Preto s√≥lido (contraste total no fundo claro)
    primary: "bg-schedy-black text-white shadow-vivid hover:bg-schedy-gray",
    
    // Outline: Borda de 2px preta, fundo transparente (Inverte no hover)
    outline: "border-2 border-schedy-black text-schedy-black bg-transparent hover:bg-schedy-black hover:text-white",
    
    // Ghost: Para a√ß√µes secund√°rias, apenas texto e hover suave
    ghost: "text-schedy-gray hover:text-schedy-black hover:bg-schedy-canvas",
    
    // Danger: Para exclus√£o (Vermelho Vivo)
    danger: "bg-schedy-danger text-white hover:bg-red-700 shadow-sm"
  };

  return (
    <button 
      disabled={loading}
      className={`${baseStyles} ${variants[variant]} ${className}`}
      {...props}
    >
      {loading ? (
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
          <span className="animate-pulse">Sincronizando...</span>
        </div>
      ) : children}
    </button>
  );
}
```


--- ARQUIVO: src/components/ui/Input.jsx ---
```javascript
import React from 'react';

/**
 * Input Component - Schedy Premium UI
 * Foco: Legibilidade imediata, estados de foco n√≠tidos e contraste absoluto.
 */
export function Input({ label, type = "text", error, ...props }) {
  return (
    <div className="flex flex-col gap-1.5 w-full group">
      {label && (
        <label className="text-[10px] font-black text-schedy-gray uppercase tracking-[0.2em] ml-1 group-focus-within:text-schedy-black transition-colors">
          {label}
        </label>
      )}
      
      <div className="relative">
        <input 
          type={type}
          className={`
            w-full bg-schedy-canvas border-2 rounded-2xl p-4 
            text-schedy-black font-bold text-sm
            placeholder:text-schedy-gray/50 
            transition-all duration-200 outline-none
            /* Estado Normal: Borda sutil */
            ${error ? 'border-schedy-danger' : 'border-schedy-border'}
            /* Estado Foco: Borda preta e leve eleva√ß√£o */
            focus:border-schedy-black focus:bg-white focus:shadow-sm
          `}
          {...props}
        />
        
        {/* Indicador visual de erro (√çcone de exclama√ß√£o opcional ou apenas borda) */}
        {error && (
          <div className="absolute right-4 top-1/2 -translate-y-1/2 text-schedy-danger">
             <span className="text-xs font-black">!</span>
          </div>
        )}
      </div>

      {error && (
        <span className="text-[10px] font-bold text-schedy-danger uppercase tracking-widest ml-1 animate-in fade-in slide-in-from-top-1">
          {error}
        </span>
      )}
    </div>
  );
}
```


--- ARQUIVO: src/components/calendar/DayView.jsx ---
```javascript
import React, { useRef } from 'react';
import { DndContext, useSensor, useSensors, PointerSensor, MouseSensor, TouchSensor } from '@dnd-kit/core';
import { 
  hoursArray, 
  getNewStartTime, 
  START_HOUR, 
  getPositionFromTime,
  PIXELS_PER_HOUR
} from '../../utils/timeGrid'; 
import { AppointmentCard } from './AppointmentCard';
import { addDays, format, isSameDay, setHours, setMinutes, startOfWeek } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import { ChevronLeft, ChevronRight, Calendar as CalendarIcon, Filter } from 'lucide-react';

// MEDIDA DE OURO: A largura da coluna de horas deve ser id√™ntica em todos os n√≠veis
const TIME_COLUMN_WIDTH = 'w-16 md:w-20'; 

export function DayView({ 
  appointments, 
  onAppointmentMove, 
  onAppointmentClick, 
  onTimeSlotClick, 
  onComplete, 
  onDelete,   
  startDate = new Date(),
  onNavigate,
  businessHours,
  timezone = "Europe/Lisbon"
}) {
  const scrollContainerRef = useRef(null);
  const firstDayOfWeek = startOfWeek(startDate, { weekStartsOn: 0 });
  const days = Array.from({ length: 7 }, (_, i) => addDays(firstDayOfWeek, i));

  const sensors = useSensors(
    useSensor(MouseSensor, { activationConstraint: { distance: 10 } }),
    useSensor(TouchSensor, { activationConstraint: { delay: 250, tolerance: 5 } })
  );

  const handleDragEnd = (event) => {
    const { active, delta } = event;
    if (!delta.y) return;
    const appointment = active.data.current;
    const newStartTime = getNewStartTime(appointment.startTime, delta.y, PIXELS_PER_HOUR);
    if (onAppointmentMove) onAppointmentMove(appointment.id, newStartTime);
  };

  const handleGridClick = (e, dayDate) => {
    if (e.target.closest('[data-appointment-card]')) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const offsetY = e.clientY - rect.top; 
    const hoursPassed = offsetY / PIXELS_PER_HOUR;
    const hour = Math.floor(hoursPassed) + START_HOUR;
    const minutes = Math.floor((hoursPassed % 1) * 60);
    const roundedMinutes = Math.round(minutes / 15) * 15;
    let clickedDate = setHours(dayDate, hour);
    clickedDate = setMinutes(clickedDate, roundedMinutes);
    clickedDate.setSeconds(0);
    clickedDate.setMilliseconds(0);
    if (onTimeSlotClick) onTimeSlotClick(clickedDate);
  };

  const getTop = (timeStr) => {
    if (!timeStr || timeStr === "none") return 0;
    return getPositionFromTime(`2026-01-01T${timeStr}:00`, PIXELS_PER_HOUR);
  };

  return (
    <DndContext sensors={sensors} onDragEnd={handleDragEnd}>
      <div className="flex flex-col h-full bg-white rounded-[24px] border border-schedy-border shadow-premium overflow-hidden transition-all">
        
        {/* 1. HEADER SLIM (ESTILO AVEC) - Reduzido de h-20 para h-14 */}
        <div className="flex items-center justify-between px-6 h-14 border-b border-schedy-border shrink-0 bg-white z-30">
          <div className="flex items-center gap-3">
            <span className="text-sm font-black uppercase italic tracking-tighter text-schedy-black">
              {format(firstDayOfWeek, 'MMMM yyyy', { locale: ptBR })}
            </span>
          </div>
          
          <div className="flex items-center gap-2">
            <div className="flex items-center bg-schedy-canvas p-1 rounded-xl border border-schedy-border">
                <button onClick={() => onNavigate(addDays(startDate, -7))} className="p-1.5 hover:bg-white rounded-lg text-schedy-black transition-all">
                    <ChevronLeft size={16} />
                </button>
                <button onClick={() => onNavigate(new Date())} className="px-3 text-[9px] font-black uppercase tracking-widest text-schedy-black">
                    Hoje
                </button>
                <button onClick={() => onNavigate(addDays(startDate, 7))} className="p-1.5 hover:bg-white rounded-lg text-schedy-black transition-all">
                    <ChevronRight size={16} />
                </button>
            </div>
            <button className="p-2 bg-schedy-canvas border border-schedy-border rounded-xl text-schedy-gray hover:text-schedy-black transition-all">
                <Filter size={16} />
            </button>
          </div>
        </div>

        {/* 2. DIAS DA SEMANA (HEADER DA GRADE) - Alinhamento Matem√°tico */}
        <div className="flex border-b border-schedy-border bg-white z-20 shadow-sm">
          <div className={`${TIME_COLUMN_WIDTH} shrink-0 border-r border-schedy-border bg-schedy-canvas/10`} />
          <div className="flex-1 grid grid-cols-7">
            {days.map((day, index) => (
              <div key={index} className="py-2 text-center border-r border-schedy-border last:border-r-0">
                <span className="block text-[8px] font-black text-schedy-gray uppercase tracking-widest">
                  {format(day, 'EEE', { locale: ptBR })}
                </span>
                <span className={`
                  inline-flex items-center justify-center w-7 h-7 rounded-full font-black text-xs mt-0.5
                  ${isSameDay(day, new Date()) ? 'bg-schedy-black text-white' : 'text-schedy-black'}
                `}>
                  {format(day, 'dd')}
                </span>
              </div>
            ))}
          </div>
        </div>

        {/* 3. √ÅREA DA GRADE (SCROLL) */}
        <div ref={scrollContainerRef} className="flex-1 overflow-y-auto relative bg-white select-none custom-scrollbar">
          <div className="flex relative" style={{ height: hoursArray.length * PIXELS_PER_HOUR }}>
            
            {/* EIXO DE HORAS (FIXO) */}
            <div className={`${TIME_COLUMN_WIDTH} shrink-0 border-r border-schedy-border bg-white sticky left-0 z-10 shadow-[2px_0_5px_rgba(0,0,0,0.02)]`}>
              {hoursArray.map((hour) => (
                <div 
                  key={hour} 
                  className="absolute w-full text-center text-[9px] font-black text-schedy-gray/50 -mt-2.5" 
                  style={{ top: (hour - START_HOUR) * PIXELS_PER_HOUR }}
                >
                  {hour.toString().padStart(2, '0')}:00
                </div>
              ))}
            </div>

            {/* COLUNAS DOS DIAS (GRID REAL) */}
            <div className="flex-1 grid grid-cols-7 h-full">
                {days.map((day, colIndex) => {
                  const dayAppointments = appointments.filter(apt => isSameDay(new Date(apt.startTime), day));
                  return (
                    <div 
                      key={colIndex} 
                      className="relative border-r border-schedy-border last:border-r-0 hover:bg-schedy-canvas/20 transition-colors" 
                      onClick={(e) => handleGridClick(e, day)}
                    >
                      {/* LINHAS HORIZONTAIS DE FUNDO */}
                      {hoursArray.map((hour) => (
                        <div 
                          key={hour} 
                          className="absolute w-full border-b border-schedy-border/30" 
                          style={{ top: (hour - START_HOUR) * PIXELS_PER_HOUR, height: PIXELS_PER_HOUR }} 
                        />
                      ))}

                      {/* CARDS */}
                      {dayAppointments.map((apt) => (
                        <div key={apt.id} data-appointment-card>
                            <AppointmentCard 
                                appointment={apt} 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onAppointmentClick(apt);
                                }}
                            />
                        </div>
                      ))}
                    </div>
                  );
                })}
            </div>
          </div>
        </div>
      </div>
    </DndContext>
  );
}
```


--- ARQUIVO: src/components/calendar/AppointmentCard.jsx ---
```javascript
import React from 'react';
import { useDraggable } from '@dnd-kit/core';
import { CSS } from '@dnd-kit/utilities';
import { AlertCircle, Lock, Phone } from 'lucide-react'; 
import { 
  getPositionFromTime, 
  getHeightFromDuration, 
  getNewStartTime,    
  formatTimeDisplay,
  PIXELS_PER_HOUR
} from '../../utils/timeGrid';

export function AppointmentCard({ appointment, onClick }) {
  
  // C√°lculo de posi√ß√£o e altura baseados no novo grid de 100px/hora
  const top = getPositionFromTime(appointment.startTime, PIXELS_PER_HOUR);
  const height = getHeightFromDuration(appointment.duration, PIXELS_PER_HOUR);
  
  const isCompleted = appointment.status === 'completed';
  const isBlocked = appointment.type === 'block'; 
  const hasNotes = appointment.notes && appointment.notes.trim().length > 0;
  
  // Cor din√¢mica vinda do Firestore (campo color do servi√ßo)
  const serviceColor = appointment.color || 'emerald';

  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: appointment.id,
    data: appointment,
    disabled: isCompleted 
  });

  // Feedback visual de tempo durante o arraste
  let displayTime = formatTimeDisplay(appointment.startTime);
  if (isDragging && transform) {
    const projectedTimeISO = getNewStartTime(appointment.startTime, transform.y, PIXELS_PER_HOUR);
    displayTime = formatTimeDisplay(projectedTimeISO);
  }

  // Hierarquia visual baseada na altura do card
  const isLarge = height >= 70; // 45min ou mais
  const isMedium = height >= 45; // 30min

  const style = {
    top: `${top}px`,
    height: `${height - 2}px`, // Pequeno gap entre cards
    zIndex: isDragging ? 100 : 10, 
    transform: CSS.Translate.toString(transform),
    position: 'absolute',
    left: '4px',  
    right: '4px', 
    touchAction: 'none',
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="group"
    >
      <div
        {...listeners}
        {...attributes}
        onClick={(e) => onClick(e)}
        className={`
          w-full h-full rounded-2xl transition-all duration-200 overflow-hidden relative shadow-sm
          ${isDragging 
            ? 'ring-4 ring-schedy-black shadow-vivid scale-[1.02] z-[100] cursor-grabbing'
            : isCompleted
              ? 'bg-schedy-border opacity-40 grayscale cursor-default'
              : isBlocked
                ? 'bg-schedy-gray border-2 border-dashed border-schedy-border cursor-not-allowed'
                : `bg-service-${serviceColor} hover:shadow-vivid hover:-translate-y-0.5 cursor-pointer`
          }
        `}
      >
        <div className="p-3 flex flex-col h-full pointer-events-none text-white">
          
          {/* TOPO: Hora e Alerta */}
          <div className="flex justify-between items-start mb-1">
            <span className={`font-black tracking-tighter italic ${isLarge ? 'text-sm' : 'text-[10px]'}`}>
              {displayTime}
            </span>
            {hasNotes && !isDragging && (
              <AlertCircle size={isMedium ? 14 : 10} className="text-white/80" />
            )}
          </div>

          {/* MEIO: Nome do Cliente */}
          <div className="min-w-0 flex-1">
            <h4 className={`font-black uppercase italic leading-tight truncate ${isLarge ? 'text-sm' : 'text-[11px]'}`}>
              {isBlocked && <Lock size={12} className="inline mr-1" />}
              {appointment.clientName}
            </h4>
            
            {/* DETALHES: Servi√ßo e Telefone (Apenas se houver espa√ßo) */}
            {isMedium && (
              <p className="text-[9px] font-bold opacity-90 uppercase truncate mt-0.5">
                {appointment.serviceName}
              </p>
            )}
          </div>

          {/* RODAP√â: Telefone (Apenas se for card grande) */}
          {isLarge && appointment.clientPhone && (
            <div className="flex items-center gap-1 mt-auto pt-1 border-t border-white/20">
              <Phone size={8} />
              <span className="text-[8px] font-bold tabular-nums">
                {appointment.clientPhone}
              </span>
            </div>
          )}

          {/* Overlay de Conclu√≠do */}
          {isCompleted && (
            <div className="absolute inset-0 bg-white/20 flex items-center justify-center">
               <span className="text-[10px] font-black uppercase text-schedy-black bg-white px-2 py-1 rounded-lg">Done</span>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```
